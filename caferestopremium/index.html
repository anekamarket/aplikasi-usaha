<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFE & RESTO POS SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification message</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal" style="display: none; background: rgba(0,0,0,0.8);">
        <div class="text-center" style="color: white;">
            <div class="loading" style="width: 50px; height: 50px; border-width: 5px;"></div>
            <p class="mt-3" style="font-size: 1.2rem;">Memproses...</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-store"></i>
                </div>
                <h1 class="login-title">POS SYSTEM</h1>
                <p class="login-subtitle">Sistem Point of Sale Premium - Cafe & Restoran</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" class="form-control" value="admin" readonly>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" class="form-control" value="premium123" readonly>
                </div>
                
                <div class="form-group mt-4">
                    <label for="captcha" class="form-label"><i class="fas fa-shield-alt"></i> Verifikasi Keamanan</label>
                    <div class="d-flex align-center gap-2">
                        <canvas id="captchaCanvas" width="180" height="50" style="border: 2px solid #ddd; border-radius: var(--rounded-sm); background: #f8f9fa;"></canvas>
                        <button type="button" id="reloadCaptchaBtn" class="btn btn-sm btn-outline" style="width: auto; padding: 10px;">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <input type="text" id="captchaInput" class="form-control mt-2" placeholder="Masukkan kode di atas" required>
                </div>
                <button type="submit" class="btn mt-4">
                    <i class="fas fa-sign-in-alt"></i> Login ke Sistem
                </button>
            </form>
            
            <div class="mt-4 text-center">
                <p style="color: var(--gray); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Sistem POS Premium v2.0
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div class="header-title-container">
                <div class="header-logo">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div>
                    <h1 class="app-title" id="storeNameHeader">CAFE & RESTO POS</h1>
                    <p id="currentDate" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-calendar"></i>
                        <span>Rabu, 24 September 2025</span>
                    </p>
                </div>
            </div>
            <div class="header-info">
                <p><i class="fas fa-user-tie"></i> <span id="loggedInUser">Administrator</span></p>
                <p><i class="fas fa-shopping-cart"></i> <span id="headerOrderCount">0 item</span></p>
                <p><a href="#" id="logoutBtn" style="color: white; text-decoration: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a></p>
            </div>
        </header>

        <main class="app-content">
            <!-- Menu Panel -->
            <section class="panel menu-panel">
                <h2 class="panel-title">
                    <span><i class="fas fa-utensils"></i> Daftar Menu</span>
                    <span id="menuCount" class="badge badge-info">0 menu</span>
                </h2>
                
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="menuSearch" class="search-input" placeholder="Cari menu...">
                </div>
                
                <div class="d-flex justify-between align-center mb-3">
                    <div class="filter-row" id="filterRow">
                        <div class="filter-chip active" data-category="all">Semua Menu</div>
                    </div>
                    <div>
                        <select id="sortMenu" class="form-control" style="width: auto; min-width: 180px;">
                            <option value="name_asc">Nama A-Z</option>
                            <option value="name_desc">Nama Z-A</option>
                            <option value="price_asc">Harga Terendah</option>
                            <option value="price_desc">Harga Tertinggi</option>
                        </select>
                    </div>
                </div>
                
                <div class="menu-grid" id="menuGrid">
                    <!-- Menu items will be loaded here -->
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <h3 class="panel-title">
                        <i class="fas fa-cogs"></i> Panel Administrator
                    </h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-utensils fa-2x" style="color: var(--secondary);"></i>
                            <div class="stat-value" id="totalMenus">0</div>
                            <div class="stat-label">Total Menu</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-shopping-cart fa-2x" style="color: var(--success);"></i>
                            <div class="stat-value" id="totalOrders">0</div>
                            <div class="stat-label">Total Transaksi</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x" style="color: var(--info);"></i>
                            <div class="stat-value" id="totalMembers">0</div>
                            <div class="stat-label">Total Member</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-line fa-2x" style="color: var(--warning);"></i>
                            <div class="stat-value" id="totalRevenue">Rp 0</div>
                            <div class="stat-label">Total Pendapatan</div>
                        </div>
                    </div>
                    
                    <div class="admin-grid mt-4">
                        <button id="addMenuBtn" class="btn btn-sm btn-success">
                            <i class="fas fa-plus-circle"></i> Tambah Menu
                        </button>
                        <button id="manageCategoriesBtn" class="btn btn-sm btn-info">
                            <i class="fas fa-tags"></i> Kelola Kategori
                        </button>
                        <button id="viewReportsBtn" class="btn btn-sm btn-warning">
                            <i class="fas fa-chart-bar"></i> Laporan & Analisis
                        </button>
                        <button id="historyBtn" class="btn btn-sm">
                            <i class="fas fa-history"></i> Histori Transaksi
                        </button>
                        <button id="kitchenDisplayBtn" class="btn btn-sm btn-warning">
                            <i class="fas fa-tv"></i> Display Dapur
                        </button>
                        <button id="manageMembersBtn" class="btn btn-sm btn-info">
                            <i class="fas fa-users-cog"></i> Kelola Member
                        </button>
                        <button id="manageStoreInfoBtn" class="btn btn-sm">
                            <i class="fas fa-store"></i> Info Restoran
                        </button>
                        <button id="controlPanelBtn" class="btn btn-sm btn-danger">
                            <i class="fas fa-sliders-h"></i> Kontrol Panel
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="panel-title">
                            <i class="fas fa-database"></i> Backup & Restore Data
                        </h4>
                        <div class="d-flex gap-2">
                            <button id="backupDataBtn" class="btn btn-sm btn-info w-100">
                                <i class="fas fa-download"></i> Backup Data
                            </button>
                            <label for="restoreFile" class="btn btn-sm btn-outline w-100" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Restore Data
                                <input type="file" id="restoreFile" class="file-input" accept=".json,.posbackup" style="display: none;">
                            </label>
                        </div>
                        <button id="resetDataBtn" class="btn btn-sm btn-danger w-100 mt-2">
                            <i class="fas fa-trash"></i> Reset Data ke Default
                        </button>
                    </div>
                </div>
            </section>

            <!-- Order Panel -->
            <section class="panel order-panel">
                <h2 class="panel-title">
                    <span><i class="fas fa-shopping-cart"></i> Pesanan Aktif</span>
                    <span id="orderCount" class="badge badge-success">0 item</span>
                </h2>
                
                <div class="order-type">
                    <div class="order-type-btn active" data-type="dinein">
                        <i class="fas fa-utensils"></i> Makan di Tempat
                    </div>
                    <div class="order-type-btn" data-type="takeaway">
                        <i class="fas fa-shopping-bag"></i> Bungkus
                    </div>
                </div>
                
                <div class="table-number" id="tableNumberContainer">
                    <label class="form-label"><i class="fas fa-chair"></i> Nomor Meja</label>
                    <select id="tableNumber" class="form-control">
                        <option value="1">Meja 1</option>
                        <option value="2">Meja 2</option>
                        <option value="3">Meja 3</option>
                        <option value="4">Meja 4</option>
                        <option value="5">Meja 5</option>
                    </select>
                </div>

                <div class="form-group mt-3">
                    <label class="form-label"><i class="fas fa-user-tag"></i> Member (opsional)</label>
                    <div class="member-search-container">
                        <input type="text" id="memberSearchInput" class="form-control" placeholder="Cari nama, ID, atau No. HP...">
                        <div id="memberSearchResults" class="member-search-results"></div>
                    </div>
                    <div id="memberInfo" class="mt-2" style="display: none;">
                        <div class="d-flex justify-between align-center bg-light p-2 rounded">
                            <span id="selectedMemberName"></span>
                            <span id="selectedMemberDiscount" class="badge badge-success"></span>
                        </div>
                    </div>
                </div>
                
                <div id="orderItems" class="mt-3" style="max-height: 300px; overflow-y: auto;">
                    <!-- Order items will be loaded here -->
                </div>
                
                <div class="note-input mt-3">
                    <label class="form-label"><i class="fas fa-sticky-note"></i> Catatan Pesanan</label>
                    <textarea id="orderNote" class="form-control" placeholder="Contoh: Pedas, tanpa bawang, tambah es, dll."></textarea>
                </div>
                
                <div class="summary-container">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">Rp 0</span>
                    </div>
                    <div id="discountRow" class="summary-row" style="display: none;">
                        <span>Diskon Member:</span>
                        <span id="orderDiscount" class="text-success">-Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Pajak (10%):</span>
                        <span id="orderTax">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Service (5%):</span>
                        <span id="orderService">Rp 0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>TOTAL:</span>
                        <span id="orderTotal">Rp 0</span>
                    </div>
                </div>
                
                <button id="processOrderBtn" class="btn btn-success mt-4" disabled>
                    <i class="fas fa-cash-register"></i> Proses Pembayaran
                </button>
                <button id="clearOrderBtn" class="btn btn-outline mt-2">
                    <i class="fas fa-trash"></i> Kosongkan Pesanan
                </button>
            </section>
        </main>

        <!-- Quick Actions -->
        <button id="quickActionsBtn" class="floating-action-btn">
            <i class="fas fa-bolt"></i>
        </button>

        <footer class="app-footer">
            <p>
                <i class="fas fa-copyright"></i> <span id="currentYear"></span> 
                CAFE & RESTO POS SYSTEM v2.0 | 
                <span style="color: var(--secondary);">Powered by Lentera Karya Situbondo</span>
            </p>
            <p style="font-size: 0.8rem; margin-top: 5px;">
                <i class="fas fa-shield-alt"></i> Sistem Terenkripsi | 
                <i class="fas fa-mobile-alt"></i> Responsif | 
                <i class="fas fa-bolt"></i> Premium Edition
            </p>
        </footer>
    </div>

    <!-- Modals -->
    <!-- Process Order Modal -->
    <div id="processOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cash-register"></i> Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="payment">
                        <i class="fas fa-money-bill-wave"></i> Pembayaran
                    </div>
                    <div class="tab" data-tab="details">
                        <i class="fas fa-receipt"></i> Detail Pesanan
                    </div>
                </div>

                <div class="tab-content active" id="paymentTab">
                    <div class="payment-total-display">
                        <p>Total yang harus dibayar</p>
                        <h3 id="paymentTotal">Rp 0</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-credit-card"></i> Metode Pembayaran</label>
                        <select id="paymentMethod" class="form-control">
                            <option value="cash">üíµ Tunai</option>
                            <option value="debit">üí≥ Kartu Debit</option>
                            <option value="credit">üí≥ Kartu Kredit</option>
                            <option value="transfer">üè¶ Transfer Bank</option>
                            <option value="qris">üì± QRIS</option>
                            <option value="ewallet">üì± E-Wallet</option>
                        </select>
                    </div>

                    <div class="quick-cash-buttons" id="quickCashButtons">
                        <!-- Quick cash buttons will be loaded here -->
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-money-check-alt"></i> Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmount" class="form-control" placeholder="Masukkan jumlah" min="0" step="1000">
                    </div>

                    <div id="changeContainer" style="display: none;">
                        <div class="payment-total-display mt-3" style="background: var(--success); color: white;">
                            <p>Kembalian</p>
                            <h3 id="paymentChange">Rp 0</h3>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="detailsTab">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user"></i> Nama Pelanggan</label>
                        <input type="text" id="customerName" class="form-control" placeholder="Masukkan nama pelanggan">
                    </div>
                    <div id="orderSummary" class="summary-container">
                        <!-- Order summary will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button id="completePaymentBtn" class="btn btn-success" disabled>
                    <i class="fas fa-check-circle"></i> Selesaikan Pembayaran
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-utensils"></i> Kelola Menu</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="menuId">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-tag"></i> Nama Menu</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-filter"></i> Kategori</label>
                        <select id="menuCategory" class="form-control" required>
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-money-bill-wave"></i> Harga</label>
                        <input type="number" id="menuPrice" class="form-control" required min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-image"></i> Gambar (URL)</label>
                        <input type="text" id="menuImage" class="form-control" placeholder="Masukkan URL gambar atau kosongkan untuk default">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-align-left"></i> Deskripsi</label>
                        <textarea id="menuDescription" class="form-control" placeholder="Deskripsi menu..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn btn-success" id="saveMenuBtn">
                    <i class="fas fa-save"></i> Simpan Menu
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Modal -->
    <div id="manageCategoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-tags"></i> Kelola Kategori</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="categoriesList">
                    <!-- Categories will be loaded here -->
                </div>
                <div class="form-group mt-3">
                    <label class="form-label"><i class="fas fa-plus-circle"></i> Tambah Kategori Baru</label>
                    <div class="d-flex gap-2">
                        <input type="text" id="newCategoryName" class="form-control" placeholder="Nama kategori baru">
                        <button class="btn btn-success" id="addCategoryBtn" style="width: auto;">
                            <i class="fas fa-plus"></i> Tambah
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chart-bar"></i> Laporan & Analisis</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="salesReport">
                        <i class="fas fa-chart-line"></i> Laporan Penjualan
                    </div>
                    <div class="tab" data-tab="productReport">
                        <i class="fas fa-utensils"></i> Laporan Produk
                    </div>
                    <div class="tab" data-tab="memberReport">
                        <i class="fas fa-users"></i> Laporan Member
                    </div>
                </div>
                
                <div class="tab-content active" id="salesReportTab">
                    <div class="form-group mt-3">
                        <label class="form-label"><i class="fas fa-calendar"></i> Periode Laporan</label>
                        <select id="reportPeriod" class="form-control">
                            <option value="today">Hari Ini</option>
                            <option value="yesterday">Kemarin</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="last_month">Bulan Lalu</option>
                            <option value="year">Tahun Ini</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div id="customDateRange" style="display: none;">
                        <div class="d-flex gap-2">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Dari Tanggal</label>
                                <input type="date" id="reportStartDate" class="form-control">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Sampai Tanggal</label>
                                <input type="date" id="reportEndDate" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div id="reportResults" class="mt-3 printable-area"></div>
                </div>
                
                <div class="tab-content" id="productReportTab">
                    <div class="form-group mt-3">
                        <label class="form-label"><i class="fas fa-filter"></i> Filter Produk</label>
                        <select id="productFilter" class="form-control">
                            <option value="all">Semua Produk</option>
                            <option value="top10">10 Produk Terlaris</option>
                            <option value="least10">10 Produk Terendah</option>
                            <option value="category">Berdasarkan Kategori</option>
                        </select>
                    </div>
                    <div id="productResults" class="mt-3"></div>
                </div>
                
                <div class="tab-content" id="memberReportTab">
                    <div id="memberReportResults" class="mt-3"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button class="btn btn-success" id="generateReportBtn">
                    <i class="fas fa-sync"></i> Generate Laporan
                </button>
                <button class="btn btn-info" id="downloadReportBtn" style="display: none;">
                    <i class="fas fa-file-pdf"></i> Unduh PDF
                </button>
                <button class="btn btn-primary" id="printReportBtn" style="display: none;">
                    <i class="fas fa-print"></i> Cetak Laporan
                </button>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-history"></i> Histori Transaksi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-container mb-3">
                    <i class="fas fa-search"></i>
                    <input type="text" id="historySearchInput" class="search-input" placeholder="Cari berdasarkan Kode Transaksi, Nama Pelanggan...">
                </div>
                <div class="d-flex gap-2 mb-3">
                    <select id="historyFilter" class="form-control" style="flex: 1;">
                        <option value="all">Semua Transaksi</option>
                        <option value="today">Hari Ini</option>
                        <option value="week">Minggu Ini</option>
                        <option value="month">Bulan Ini</option>
                    </select>
                    <select id="historySort" class="form-control" style="width: auto;">
                        <option value="newest">Terbaru</option>
                        <option value="oldest">Terlama</option>
                        <option value="highest">Total Tertinggi</option>
                        <option value="lowest">Total Terendah</option>
                    </select>
                </div>
                <div id="historyResultsContainer" style="max-height: 60vh; overflow-y: auto;">
                    <div id="historyResults" class="printable-area"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button class="btn btn-info" id="downloadHistoryBtn">
                    <i class="fas fa-file-pdf"></i> Unduh PDF
                </button>
                <button class="btn btn-primary" id="printHistoryBtn">
                    <i class="fas fa-print"></i> Cetak Histori
                </button>
            </div>
        </div>
    </div>

    <!-- Kitchen Display Modal -->
    <div id="kitchenDisplayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-tv"></i> Display Dapur</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="kitchen-status">
                    <h4>
                        <i class="fas fa-bell"></i> Pesanan Masuk
                        <span class="badge badge-warning" id="kitchenOrderCount">0</span>
                    </h4>
                    <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 15px;">
                        <i class="fas fa-sync-alt"></i> Auto-refresh setiap 30 detik
                    </p>
                    <div id="kitchenOrders">
                        <!-- Kitchen orders will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button class="btn btn-success" id="refreshKitchenBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Manual
                </button>
                <button class="btn btn-info" id="clearCompletedBtn">
                    <i class="fas fa-check-double"></i> Bersihkan Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="manageMembersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-users-cog"></i> Kelola Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <button id="showAddMemberFormBtn" class="btn btn-success mb-3">
                    <i class="fas fa-user-plus"></i> Tambah Member Baru
                </button>
                
                <div class="search-container mb-3">
                    <i class="fas fa-search"></i>
                    <input type="text" id="manageMemberSearchInput" class="search-input" placeholder="Cari member (nama, ID, No. HP)...">
                </div>

                <div class="member-form" id="memberFormContainer" style="display:none; background: #f8f9fa; padding: 20px; border-radius: var(--rounded);">
                    <h4 id="memberFormTitle" class="panel-title">
                        <i class="fas fa-user-edit"></i> Tambah Member Baru
                    </h4>
                    <form id="memberForm">
                        <input type="hidden" id="memberIdInput">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> Nama Member</label>
                            <input type="text" id="memberName" class="form-control" placeholder="Masukkan nama member" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Nomor Telepon</label>
                            <input type="tel" id="memberPhone" class="form-control" placeholder="Masukkan nomor telepon" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-map-marker-alt"></i> Alamat</label>
                            <textarea id="memberAddress" class="form-control" placeholder="Masukkan alamat"></textarea>
                        </div>
                         <div id="memberAdminFields" style="display: none;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-shopping-cart"></i> Total Transaksi</label>
                                <input type="number" id="memberTransactions" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-money-bill-wave"></i> Total Belanja</label>
                                <input type="text" id="memberTotalSpent" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                             <button type="button" class="btn btn-warning" id="cancelMemberFormBtn">
                                 <i class="fas fa-times"></i> Batal
                             </button>
                             <button type="submit" class="btn btn-success" id="saveMemberBtn">
                                 <i class="fas fa-save"></i> Simpan Member
                             </button>
                        </div>
                    </form>
                    <hr class="mt-3 mb-3">
                </div>
                <div id="membersList">
                    <!-- Members list will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button class="btn btn-danger" id="deleteMemberBtn" style="display: none;">
                    <i class="fas fa-trash"></i> Hapus Member
                </button>
            </div>
        </div>
    </div>

    <!-- Store Info Modal -->
    <div id="manageStoreInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-store"></i> Informasi Restoran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="storeInfoForm">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-building"></i> Nama Restoran</label>
                        <input type="text" id="storeName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-map-marker-alt"></i> Alamat Restoran</label>
                        <textarea id="storeAddress" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Nomor Telepon/WhatsApp</label>
                        <input type="text" id="storePhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="storeEmail" class="form-control" placeholder="resto@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-chair"></i> Jumlah Meja</label>
                        <input type="number" id="tableCount" class="form-control" min="1" max="50" value="10" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-percentage"></i> Pajak (%)</label>
                        <input type="number" id="storeTax" class="form-control" min="0" max="100" value="10" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-concierge-bell"></i> Service Charge (%)</label>
                        <input type="number" id="storeService" class="form-control" min="0" max="100" value="5" step="0.1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn btn-success" id="saveStoreInfoBtn">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- Control Panel Modal -->
    <div id="controlPanelModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-sliders-h"></i> Kontrol Panel</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="users">
                        <i class="fas fa-users-cog"></i> Pengguna
                    </div>
                    <div class="tab" data-tab="security">
                        <i class="fas fa-shield-alt"></i> Keamanan
                    </div>
                    <div class="tab" data-tab="settings">
                        <i class="fas fa-cog"></i> Pengaturan
                    </div>
                </div>

                <div class="tab-content active" id="usersTab">
                    <h4 class="mt-3"><i class="fas fa-user-friends"></i> Manajemen Pengguna</h4>
                    <button id="showAddUserFormBtn" class="btn btn-success mt-2 mb-3">
                        <i class="fas fa-user-plus"></i> Tambah Pengguna Baru
                    </button>
                    <div id="userFormContainer" style="display:none; background: #f8f9fa; padding: 20px; border-radius: var(--rounded); margin-bottom: 20px;">
                        <h5 id="userFormTitle" class="panel-title">
                            <i class="fas fa-user-edit"></i> Tambah Pengguna
                        </h5>
                        <form id="userForm">
                            <input type="hidden" id="userIdInput">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user"></i> Nama Lengkap</label>
                                <input type="text" id="userName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-at"></i> Username</label>
                                <input type="text" id="userUsername" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-key"></i> Password</label>
                                <input type="password" id="userPassword" class="form-control" placeholder="Kosongkan jika tidak ingin mengubah">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-tag"></i> Hak Akses (Role)</label>
                                <select id="userRole" class="form-control">
                                    <option value="cashier">Kasir</option>
                                    <option value="admin">Administrator</option>
                                    <option value="kitchen">Dapur</option>
                                </select>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning" id="cancelUserFormBtn">
                                    <i class="fas fa-times"></i> Batal
                                </button>
                                <button type="submit" class="btn btn-success" id="saveUserBtn">
                                    <i class="fas fa-save"></i> Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                    <div id="usersList"></div>
                </div>

                <div class="tab-content" id="securityTab">
                    <h4 class="mt-3"><i class="fas fa-lock"></i> Pengaturan Keamanan</h4>
                    <form id="itemSecurityForm" class="mt-3">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-edit"></i> Password Edit/Hapus Item</label>
                            <input type="password" id="itemSecurityCode" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save"></i> Ubah Password
                        </button>
                    </form>
                    <hr class="mt-3 mb-3">
                    <form id="panelSecurityForm" class="mt-2">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-sliders-h"></i> Password Kontrol Panel</label>
                            <input type="password" id="panelSecurityCode" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save"></i> Ubah Password
                        </button>
                    </form>
                    
                    <hr class="mt-3 mb-3">
                    <h4 class="mt-3"><i class="fas fa-percentage"></i> Pengaturan Diskon</h4>
                    <form id="discountSettingsForm" class="mt-2">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user-tag"></i> Diskon Member (%)</label>
                            <input type="number" id="memberDiscount" class="form-control" min="0" max="100" value="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-users"></i> Diskon Pelanggan Biasa (%)</label>
                            <input type="number" id="nonMemberDiscount" class="form-control" min="0" max="100" value="0" required>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Pengaturan Diskon
                        </button>
                    </form>
                    <hr class="mt-3 mb-3">
                    <h4 class="mt-3"><i class="fas fa-key"></i> Ubah Password Login Anda</h4>
                    <form id="changeOwnPasswordForm" class="mt-2">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock"></i> Password Saat Ini</label>
                            <input type="password" id="currentPassword" class="form-control" required>
                        </div>
                         <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock-open"></i> Password Baru</label>
                            <input type="password" id="newPassword" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Password Baru
                        </button>
                    </form>
                </div>
                
                <div class="tab-content" id="settingsTab">
                    <h4 class="mt-3"><i class="fas fa-cogs"></i> Pengaturan Sistem</h4>
                    <form id="systemSettingsForm" class="mt-3">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-bell"></i> Notifikasi Suara
                                <input type="checkbox" id="soundNotifications" class="ml-2" checked>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-sync-alt"></i> Auto-save Pesanan
                                <input type="checkbox" id="autoSave" class="ml-2" checked>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-print"></i> Auto-print Struk
                                <input type="checkbox" id="autoPrint" class="ml-2">
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-palette"></i> Tema Warna</label>
                            <select id="themeSelect" class="form-control">
                                <option value="default">Default (Biru)</option>
                                <option value="green">Hijau</option>
                                <option value="red">Merah</option>
                                <option value="purple">Ungu</option>
                                <option value="dark">Gelap</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Pengaturan
                        </button>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>
    
    <!-- Password Prompt Modal -->
    <div id="passwordPromptModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="passwordPromptTitle">
                    <i class="fas fa-lock"></i> Masukkan Password Keamanan
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="passwordPromptForm">
                    <div class="form-group">
                         <label class="form-label" id="passwordPromptMessage">
                             Untuk melanjutkan, masukkan password keamanan.
                         </label>
                         <input type="password" id="passwordPromptInput" class="form-control" required autofocus>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn btn-success" id="passwordPromptSubmit">
                    <i class="fas fa-check"></i> Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">
                    <i class="fas fa-question-circle"></i> Konfirmasi
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 1.1rem; line-height: 1.5;">Apakah Anda yakin?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning modal-close-btn" id="confirmCancel">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn" id="confirmAction">
                    <i class="fas fa-check"></i> Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header no-print">
                <h3 class="modal-title"><i class="fas fa-receipt"></i> Struk Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="receiptModalBody" style="background: white; padding: 0;">
                <!-- Receipt will be loaded here -->
            </div>
            <div class="modal-footer no-print">
                <button class="btn btn-warning modal-close-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button class="btn btn-info" id="downloadReceiptPdfBtn">
                    <i class="fas fa-file-pdf"></i> Unduh PDF
                </button>
                <button class="btn btn-success" id="printReceiptBtn">
                    <i class="fas fa-print"></i> Cetak Struk
                </button>
                <button class="btn btn-outline" id="sendWhatsAppBtn">
                    <i class="fab fa-whatsapp"></i> Kirim WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- KTA Modal -->
    <div id="ktaModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
             <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-id-card"></i> Kartu Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="ktaModalBody">
                <!-- KTA Card will be loaded here -->
            </div>
            <div class="modal-footer no-print">
                 <button class="btn btn-warning modal-close-btn">
                     <i class="fas fa-times"></i> Tutup
                 </button>
                 <button class="btn btn-info" id="downloadKtaPdfBtn">
                     <i class="fas fa-file-pdf"></i> Unduh PDF
                 </button>
                 <button class="btn btn-success" id="printKtaBtn">
                     <i class="fas fa-print"></i> Cetak Kartu
                 </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions Modal -->
    <div id="quickActionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-bolt"></i> Quick Actions</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-grid">
                    <button class="btn btn-sm btn-success quick-action-btn" data-action="newOrder">
                        <i class="fas fa-plus"></i> Pesanan Baru
                    </button>
                    <button class="btn btn-sm btn-info quick-action-btn" data-action="viewReports">
                        <i class="fas fa-chart-bar"></i> Laporan Cepat
                    </button>
                    <button class="btn btn-sm btn-warning quick-action-btn" data-action="kitchenView">
                        <i class="fas fa-tv"></i> Lihat Dapur
                    </button>
                    <button class="btn btn-sm btn-danger quick-action-btn" data-action="clearAll">
                        <i class="fas fa-trash"></i> Clear Semua
                    </button>
                    <button class="btn btn-sm btn-outline quick-action-btn" data-action="backupNow">
                        <i class="fas fa-save"></i> Backup Sekarang
                    </button>
                    <button class="btn btn-sm btn-outline quick-action-btn" data-action="toggleTheme">
                        <i class="fas fa-palette"></i> Ganti Tema
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Container (hidden) -->
    <div id="print-container" style="display:none;"></div>
    
    <!-- Audio Elements -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="cashSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-cash-register-purchase-875.mp3" type="audio/mpeg">
    </audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Set locale to Indonesian
        moment.locale('id');
        const { jsPDF } = window.jspdf;
        
        // Constants
        const STORAGE_KEYS = {
            MENUS: 'pos_menus',
            CATEGORIES: 'pos_categories',
            ORDERS: 'pos_orders',
            USER: 'pos_user',
            CURRENT_ORDER: 'pos_current_order',
            SETTINGS: 'pos_settings',
            USERS: 'pos_users',
            MEMBERS: 'pos_members',
            SYSTEM: 'pos_system'
        };

        const ENCRYPTION_KEY = 'POS-Premium-System-2025-LKS-Situbondo';
        
        // Default data
        const DEFAULT_DATA = {
            menus: [
                { 
                    id: 'M001', 
                    name: 'Nasi Goreng Spesial', 
                    category: 'Makanan', 
                    price: 25000, 
                    image: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Nasi goreng dengan telur, ayam, dan sayuran',
                    stock: 50,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M002', 
                    name: 'Mie Goreng Jawa', 
                    category: 'Makanan', 
                    price: 20000, 
                    image: 'https://images.unsplash.com/photo-1563245372-f21724e3856d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Mie goreng dengan bumbu khas Jawa',
                    stock: 45,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M003', 
                    name: 'Ayam Goreng Crispy', 
                    category: 'Makanan', 
                    price: 30000, 
                    image: 'https://images.unsplash.com/photo-1562967916-eb82221dfb92?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Ayam goreng tepung crispy dengan sambal',
                    stock: 30,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M004', 
                    name: 'Es Teh Manis', 
                    category: 'Minuman', 
                    price: 8000, 
                    image: 'https://images.unsplash.com/photo-1561127959-5c8e5c5f5b5b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Es teh dengan gula spesial',
                    stock: 100,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M005', 
                    name: 'Jus Alpukat', 
                    category: 'Minuman', 
                    price: 15000, 
                    image: 'https://images.unsplash.com/photo-1573804633927-bfcbcd909acd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Jus alpukat dengan susu dan coklat',
                    stock: 25,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M006', 
                    name: 'Cappuccino', 
                    category: 'Minuman', 
                    price: 18000, 
                    image: 'https://images.unsplash.com/photo-1534778101976-62847782c213?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Kopi cappuccino dengan busa susu',
                    stock: 40,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M007', 
                    name: 'French Fries', 
                    category: 'Snack', 
                    price: 15000, 
                    image: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Kentang goreng dengan saus special',
                    stock: 60,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'M008', 
                    name: 'Brownies Cake', 
                    category: 'Dessert', 
                    price: 12000, 
                    image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                    description: 'Brownies coklat dengan topping almond',
                    stock: 20,
                    createdAt: new Date().toISOString()
                }
            ],
            categories: [
                { id: 'C001', name: 'Makanan', color: '#3498db', icon: 'fas fa-utensils' },
                { id: 'C002', name: 'Minuman', color: '#2ecc71', icon: 'fas fa-glass-whiskey' },
                { id: 'C003', name: 'Snack', color: '#f39c12', icon: 'fas fa-cookie' },
                { id: 'C004', name: 'Dessert', color: '#9b59b6', icon: 'fas fa-ice-cream' }
            ],
            users: [
                { 
                    id: 'U001', 
                    username: 'admin', 
                    password: CryptoJS.SHA256('premium123').toString(), 
                    name: 'Administrator', 
                    role: 'admin',
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 'U002', 
                    username: 'kasir', 
                    password: CryptoJS.SHA256('kasir123').toString(), 
                    name: 'Kasir 1', 
                    role: 'cashier',
                    createdAt: new Date().toISOString()
                }
            ],
            members: [
                {
                    id: 'MEM001',
                    name: 'John Doe',
                    phone: '081234567890',
                    email: 'john@example.com',
                    address: 'Jl. Contoh No. 123',
                    joinDate: new Date().toISOString(),
                    transactions: 15,
                    totalSpent: 1250000,
                    discountRate: 10,
                    status: 'active'
                },
                {
                    id: 'MEM002',
                    name: 'Jane Smith',
                    phone: '081298765432',
                    email: 'jane@example.com',
                    address: 'Jl. Sample No. 456',
                    joinDate: new Date().toISOString(),
                    transactions: 8,
                    totalSpent: 650000,
                    discountRate: 5,
                    status: 'active'
                }
            ],
            settings: {
                storeName: 'CAFE & RESTO PREMIUM',
                storeAddress: 'Jl. Raya No. 123, Kota Situbondo',
                storePhone: '081234567890',
                storeEmail: 'info@cafe-resto.com',
                tableCount: 10,
                taxRate: 10,
                serviceRate: 5,
                memberDiscount: 10,
                nonMemberDiscount: 0,
                itemSecurityCode: CryptoJS.SHA256('edit123').toString(),
                panelSecurityCode: CryptoJS.SHA256('panel123').toString(),
                autoSave: true,
                soundNotifications: true,
                theme: 'default'
            },
            system: {
                totalRevenue: 0,
                totalTransactions: 0,
                totalCustomers: 0,
                lastBackup: null
            }
        };

        // Global variables
        let menus = [];
        let categories = [];
        let orders = [];
        let users = [];
        let members = [];
        let settings = {};
        let system = {};
        let currentUser = null;
        let currentOrder = {
            items: [],
            subtotal: 0,
            discount: 0,
            tax: 0,
            service: 0,
            total: 0,
            type: 'dinein',
            tableNumber: '1',
            note: '',
            memberId: null,
            createdAt: new Date().toISOString()
        };
        
        let captchaText = '';
        let kitchenInterval = null;
        let passwordPromptCallback = null;
        let currentTheme = 'default';
        
        // Initialize the application
        $(document).ready(function() {
            initializeData();
            setupEventListeners();
            generateCaptcha();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem(STORAGE_KEYS.USER);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                $('#loggedInUser').text(currentUser.name);
                $('#loginModal').hide();
                $('#mainApp').show();
                initializeApp();
            }
            
            // Update year in footer
            $('#currentYear').text(new Date().getFullYear());
        });
        
        // Initialize data from localStorage or defaults
        function initializeData() {
            // Initialize all data with defaults if not exists
            const dataKeys = Object.keys(STORAGE_KEYS);
            dataKeys.forEach(key => {
                const stored = localStorage.getItem(STORAGE_KEYS[key]);
                if (!stored) {
                    const defaultValue = DEFAULT_DATA[key.toLowerCase()] || [];
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(defaultValue));
                }
            });
            
            // Load all data
            menus = JSON.parse(localStorage.getItem(STORAGE_KEYS.MENUS)) || [];
            categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
            orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
            users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [];
            members = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEMBERS)) || [];
            settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || DEFAULT_DATA.settings;
            system = JSON.parse(localStorage.getItem(STORAGE_KEYS.SYSTEM)) || DEFAULT_DATA.system;
            
            // Load current order if exists
            const savedOrder = localStorage.getItem(STORAGE_KEYS.CURRENT_ORDER);
            if (savedOrder) {
                currentOrder = JSON.parse(savedOrder);
            }
            
            // Apply theme
            currentTheme = settings.theme || 'default';
            applyTheme(currentTheme);
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Login form
            $('#loginForm').submit(handleLogin);
            $('#reloadCaptchaBtn').click(generateCaptcha);
            
            // Logout
            $('#logoutBtn').click(handleLogout);
            
            // Menu search and filter
            $('#menuSearch').on('input', handleMenuSearch);
            $('#sortMenu').change(handleMenuSort);
            $(document).on('click', '.filter-chip', handleFilterClick);
            $(document).on('click', '.menu-card', addToOrder);
            
            // Order management
            $(document).on('click', '.remove-item', removeOrderItem);
            $(document).on('input', '.item-qty', updateOrderItemQty);
            $('.order-type-btn').click(handleOrderTypeChange);
            $('#tableNumber').change(updateTableNumber);
            $('#orderNote').on('input', updateOrderNote);
            $('#clearOrderBtn').click(clearOrder);
            
            // Member search
            $('#memberSearchInput').on('input', handleMemberSearch);
            $(document).on('click', '.member-search-item', selectMember);
            $(document).click(closeMemberSearchResults);
            
            // Process order
            $('#processOrderBtn').click(openPaymentModal);
            $('#completePaymentBtn').click(completePayment);
            $('#paymentAmount').on('input', calculateChange);
            $(document).on('click', '.quick-cash-btn', setQuickCashAmount);
            $('.modal-body .tabs .tab').click(switchModalTab);
            
            // Admin buttons
            $('#addMenuBtn').click(openMenuModal);
            $('#manageCategoriesBtn').click(openCategoriesModal);
            $('#viewReportsBtn').click(openReportsModal);
            $('#historyBtn').click(openHistoryModal);
            $('#kitchenDisplayBtn').click(openKitchenModal);
            $('#manageMembersBtn').click(openMembersModal);
            $('#manageStoreInfoBtn').click(openStoreInfoModal);
            $('#controlPanelBtn').click(openControlPanel);
            
            // Backup and restore
            $('#backupDataBtn').click(backupData);
            $('#restoreFile').change(handleRestoreFile);
            $('#resetDataBtn').click(resetData);
            
            // Menu modal
            $('#saveMenuBtn').click(saveMenu);
            $(document).on('click', '.edit-menu', editMenu);
            $(document).on('click', '.delete-menu', deleteMenu);
            
            // Categories modal
            $('#addCategoryBtn').click(addCategory);
            $(document).on('click', '.remove-category', removeCategory);
            
            // Member modal
            $('#showAddMemberFormBtn').click(showMemberForm);
            $('#cancelMemberFormBtn').click(hideMemberForm);
            $('#memberForm').submit(saveMember);
            $(document).on('click', '.edit-member', editMember);
            $('#deleteMemberBtn').click(deleteMember);
            $(document).on('click', '.kta-member', openKtaModal);
            
            // Store info modal
            $('#saveStoreInfoBtn').click(saveStoreInfo);
            
            // Control panel
            $('#showAddUserFormBtn').click(showUserForm);
            $('#cancelUserFormBtn').click(hideUserForm);
            $('#userForm').submit(saveUser);
            $(document).on('click', '.edit-user', editUser);
            $(document).on('click', '.delete-user', deleteUser);
            $('#itemSecurityForm').submit(changeItemSecurity);
            $('#panelSecurityForm').submit(changePanelSecurity);
            $('#discountSettingsForm').submit(saveDiscountSettings);
            $('#changeOwnPasswordForm').submit(changeOwnPassword);
            $('#systemSettingsForm').submit(saveSystemSettings);
            
            // Reports
            $('#generateReportBtn').click(generateReport);
            $('#downloadReportBtn').click(downloadReport);
            $('#printReportBtn').click(printReport);
            $('#historySearchInput').on('input', handleHistorySearch);
            $('#historyFilter').change(loadTransactionHistory);
            $('#historySort').change(loadTransactionHistory);
            $('#printHistoryBtn').click(printHistory);
            $('#downloadHistoryBtn').click(downloadHistory);
            
            // Kitchen
            $('#refreshKitchenBtn').click(loadKitchenOrders);
            $('#clearCompletedBtn').click(clearCompletedOrders);
            $(document).on('click', '.status-item', toggleOrderStatus);
            
            // Receipt
            $(document).on('click', '.reprint-receipt', reprintReceipt);
            $('#printReceiptBtn').click(printReceipt);
            $('#downloadReceiptPdfBtn').click(downloadReceipt);
            $('#sendWhatsAppBtn').click(sendReceiptWhatsApp);
            
            // KTA
            $('#downloadKtaPdfBtn').click(downloadKta);
            $('#printKtaBtn').click(printKta);
            
            // Password prompt
            $('#passwordPromptSubmit').click(submitPasswordPrompt);
            
            // Confirmation modal
            $('#confirmAction').click(confirmAction);
            $('#confirmCancel').click(cancelAction);
            
            // Quick actions
            $('#quickActionsBtn').click(openQuickActions);
            $(document).on('click', '.quick-action-btn', handleQuickAction);
            
            // Modal close buttons
            $('.modal-close, .modal-close-btn').click(closeModal);
            
            // Report period change
            $('#reportPeriod').change(toggleCustomDateRange);
            
            // Theme change
            $('#themeSelect').change(changeTheme);
            
            // Auto-update date every minute
            setInterval(updateCurrentDate, 60000);
            
            // Auto-save order every 30 seconds if enabled
            if (settings.autoSave) {
                setInterval(autoSaveOrder, 30000);
            }
        }
        
        // Initialize application after login
        function initializeApp() {
            loadMenus();
            loadCategories();
            updateOrder();
            updateCurrentDate();
            updateStoreInfo();
            updateTableNumbers();
            updateStats();
            
            // Show/hide admin panel based on role
            $('#adminPanel').toggle(currentUser.role === 'admin');
            
            // Update header
            $('#loggedInUser').text(currentUser.name);
            
            // Update date
            updateCurrentDate();
            
            // Apply settings
            applyTheme(settings.theme || 'default');
        }
        
        // Generate CAPTCHA
        function generateCaptcha() {
            const canvas = document.getElementById('captchaCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let text = '';
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Generate random text
            for (let i = 0; i < 6; i++) {
                text += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            captchaText = text;
            
            // Draw background
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw text with effects
            for (let i = 0; i < text.length; i++) {
                ctx.save();
                ctx.translate(25 + i * 25, canvas.height / 2);
                ctx.rotate((Math.random() - 0.5) * 0.3);
                
                // Random color
                const hue = Math.random() * 60 + 200; // Blue to purple range
                ctx.fillStyle = `hsl(${hue}, 70%, 30%)`;
                
                ctx.font = `bold ${20 + Math.random() * 10}px Poppins`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text[i], 0, 0);
                ctx.restore();
            }
            
            // Add noise
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.arc(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    Math.random() * 2,
                    0,
                    Math.PI * 2
                );
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.3})`;
                ctx.fill();
            }
            
            // Add lines
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.strokeStyle = `rgba(52, 152, 219, ${0.2 + Math.random() * 0.3})`;
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }
        
        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = $('#username').val();
            const password = $('#password').val();
            const captcha = $('#captchaInput').val().trim().toUpperCase();
            
            // Validate CAPTCHA
            if (captcha !== captchaText) {
                showToast('Kode CAPTCHA salah!', 'error');
                generateCaptcha();
                $('#captchaInput').val('');
                return;
            }
            
            // Find user
            const user = users.find(u => 
                u.username.toLowerCase() === username.toLowerCase() && 
                u.password === CryptoJS.SHA256(password).toString()
            );
            
            if (user) {
                currentUser = user;
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(currentUser));
                
                // Play success sound
                playSound('notification');
                
                // Show success message
                showToast(`Selamat datang, ${user.name}!`, 'success');
                
                // Switch to main app
                $('#loginModal').fadeOut(300, function() {
                    $('#mainApp').fadeIn(300);
                    initializeApp();
                });
            } else {
                showToast('Username atau password salah!', 'error');
                generateCaptcha();
                $('#captchaInput').val('');
            }
        }
        
        // Handle logout
        function handleLogout(e) {
            e.preventDefault();
            
            showConfirmation(
                'Konfirmasi Logout',
                'Apakah Anda yakin ingin logout?',
                function() {
                    currentUser = null;
                    localStorage.removeItem(STORAGE_KEYS.USER);
                    
                    $('#mainApp').fadeOut(300, function() {
                        $('#loginModal').fadeIn(300);
                        generateCaptcha();
                        $('#captchaInput').val('');
                        showToast('Anda telah logout', 'info');
                    });
                }
            );
        }
        
        // Load menus with search and filter
        function loadMenus(searchTerm = '', category = 'all', sortBy = 'name_asc') {
            let filteredMenus = [...menus];
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredMenus = filteredMenus.filter(menu => 
                    menu.name.toLowerCase().includes(term) ||
                    menu.description.toLowerCase().includes(term) ||
                    menu.category.toLowerCase().includes(term)
                );
            }
            
            // Apply category filter
            if (category !== 'all') {
                filteredMenus = filteredMenus.filter(menu => menu.category === category);
            }
            
            // Apply sorting
            switch (sortBy) {
                case 'name_desc':
                    filteredMenus.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price_asc':
                    filteredMenus.sort((a, b) => a.price - b.price);
                    break;
                case 'price_desc':
                    filteredMenus.sort((a, b) => b.price - a.price);
                    break;
                default: // name_asc
                    filteredMenus.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Update menu count
            $('#menuCount').text(`${filteredMenus.length} menu`);
            
            // Clear menu grid
            const $menuGrid = $('#menuGrid').empty();
            
            // Show empty state if no menus
            if (filteredMenus.length === 0) {
                $menuGrid.html(`
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <p>Tidak ada menu ditemukan</p>
                        ${currentUser.role === 'admin' ? 
                            '<button class="btn btn-sm btn-success mt-2" id="addMenuEmptyBtn">Tambah Menu</button>' : 
                            ''
                        }
                    </div>
                `);
                
                // Add event listener to add menu button in empty state
                $('#addMenuEmptyBtn').click(openMenuModal);
                return;
            }
            
            // Render menu cards
            filteredMenus.forEach(menu => {
                const adminActions = currentUser.role === 'admin' ? `
                    <div class="menu-actions">
                        <div class="action-btn edit-btn edit-menu" data-id="${menu.id}" title="Edit Menu">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="action-btn delete-btn delete-menu" data-id="${menu.id}" title="Hapus Menu">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                ` : '';
                
                const categoryObj = categories.find(c => c.name === menu.category);
                const categoryColor = categoryObj ? categoryObj.color : '#3498db';
                const categoryIcon = categoryObj ? categoryObj.icon : 'fas fa-tag';
                
                $menuGrid.append(`
                    <div class="menu-card" data-id="${menu.id}">
                        ${adminActions}
                        <div class="menu-image">
                            ${menu.image ? 
                                `<img src="${menu.image}" alt="${menu.name}" onerror="this.parentElement.innerHTML = '<i class=\\'fas fa-utensils\\'></i>';">` : 
                                `<i class="fas fa-utensils"></i>`
                            }
                        </div>
                        <div class="menu-name">${menu.name}</div>
                        ${menu.description ? `<div class="menu-description">${menu.description}</div>` : ''}
                        <div class="menu-price">${formatCurrency(menu.price)}</div>
                        <div class="menu-category" style="background: ${categoryColor}">
                            <i class="${categoryIcon}"></i> ${menu.category}
                        </div>
                        ${menu.stock !== undefined ? `
                            <div class="progress-bar mt-2">
                                <div class="progress-fill" style="width: ${Math.min(100, (menu.stock / 100) * 100)}%"></div>
                            </div>
                            <small style="color: var(--gray);">Stok: ${menu.stock}</small>
                        ` : ''}
                    </div>
                `);
            });
        }
        
        // Load categories for filter and select
        function loadCategories() {
            // Update filter row
            const $filterRow = $('#filterRow').html(`
                <div class="filter-chip active" data-category="all">Semua Menu</div>
            `);
            
            categories.forEach(category => {
                $filterRow.append(`
                    <div class="filter-chip" data-category="${category.name}" style="border-left: 3px solid ${category.color}">
                        <i class="${category.icon}"></i> ${category.name}
                    </div>
                `);
            });
            
            // Update menu category select
            const $categorySelect = $('#menuCategory').empty();
            categories.forEach(category => {
                $categorySelect.append(`<option value="${category.name}">${category.name}</option>`);
            });
        }
        
        // Update order display
        function updateOrder() {
            // Calculate totals
            currentOrder.subtotal = currentOrder.items.reduce((total, item) => {
                return total + (item.menu.price * item.quantity);
            }, 0);
            
            // Apply member discount if available
            let discountRate = 0;
            if (currentOrder.memberId) {
                const member = members.find(m => m.id === currentOrder.memberId);
                discountRate = member ? member.discountRate : settings.memberDiscount;
            } else {
                discountRate = settings.nonMemberDiscount;
            }
            
            currentOrder.discount = currentOrder.subtotal * (discountRate / 100);
            const afterDiscount = currentOrder.subtotal - currentOrder.discount;
            
            // Calculate tax and service
            currentOrder.tax = afterDiscount * (settings.taxRate / 100);
            currentOrder.service = afterDiscount * (settings.serviceRate / 100);
            currentOrder.total = afterDiscount + currentOrder.tax + currentOrder.service;
            
            // Save to localStorage
            localStorage.setItem(STORAGE_KEYS.CURRENT_ORDER, JSON.stringify(currentOrder));
            
            // Update UI
            updateOrderItems();
            updateOrderSummary();
            updateHeaderOrderInfo();
            
            // Enable/disable process order button
            $('#processOrderBtn').prop('disabled', currentOrder.items.length === 0);
        }
        
        // Update order items list
        function updateOrderItems() {
            const $orderItems = $('#orderItems').empty();
            $('#orderCount').text(`${currentOrder.items.length} item`);
            
            if (currentOrder.items.length === 0) {
                $orderItems.html(`
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Belum ada pesanan</p>
                        <p style="font-size: 0.9rem;">Klik menu untuk menambahkan pesanan</p>
                    </div>
                `);
                return;
            }
            
            currentOrder.items.forEach((item, index) => {
                const itemTotal = item.menu.price * item.quantity;
                $orderItems.append(`
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">
                                ${item.menu.name}
                                ${item.note ? `<br><small style="color: var(--gray); font-style: italic;">${item.note}</small>` : ''}
                            </div>
                            <div class="order-item-price">
                                ${formatCurrency(item.menu.price)} √ó ${item.quantity}
                                <span style="color: var(--success); font-weight: bold;">= ${formatCurrency(itemTotal)}</span>
                            </div>
                        </div>
                        <div class="order-item-qty">
                            <button class="qty-btn minus-btn" data-index="${index}">-</button>
                            <input type="number" class="item-qty" data-index="${index}" value="${item.quantity}" min="1">
                            <button class="qty-btn plus-btn" data-index="${index}">+</button>
                            <button class="remove-btn remove-item" data-index="${index}" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
        }
        
        // Update order summary
        function updateOrderSummary() {
            const discountRate = currentOrder.memberId ? 
                (members.find(m => m.id === currentOrder.memberId)?.discountRate || settings.memberDiscount) : 
                settings.nonMemberDiscount;
            
            $('#orderSubtotal').text(formatCurrency(currentOrder.subtotal));
            $('#orderDiscount').text(`-${formatCurrency(currentOrder.discount)}`);
            $('#orderTax').text(formatCurrency(currentOrder.tax));
            $('#orderService').text(formatCurrency(currentOrder.service));
            $('#orderTotal').text(formatCurrency(currentOrder.total));
            
            // Show/hide discount row
            $('#discountRow').toggle(currentOrder.discount > 0);
            
            // Update member info
            if (currentOrder.memberId) {
                const member = members.find(m => m.id === currentOrder.memberId);
                if (member) {
                    $('#memberInfo').show();
                    $('#selectedMemberName').text(member.name);
                    $('#selectedMemberDiscount').text(`Diskon ${member.discountRate}%`);
                }
            } else {
                $('#memberInfo').hide();
            }
        }
        
        // Update header order info
        function updateHeaderOrderInfo() {
            const itemCount = currentOrder.items.reduce((total, item) => total + item.quantity, 0);
            $('#headerOrderCount').text(`${itemCount} item`);
        }
        
        // Add item to order
        function addToOrder() {
            const menuId = $(this).data('id');
            const menu = menus.find(m => m.id === menuId);
            
            if (!menu) return;
            
            // Check stock
            if (menu.stock !== undefined && menu.stock <= 0) {
                showToast(`Stok ${menu.name} habis!`, 'error');
                return;
            }
            
            // Check if item already in order
            const existingIndex = currentOrder.items.findIndex(item => item.menu.id === menuId);
            
            if (existingIndex > -1) {
                // Increase quantity
                currentOrder.items[existingIndex].quantity++;
                
                // Reduce stock
                if (menu.stock !== undefined) {
                    menu.stock--;
                }
            } else {
                // Add new item
                currentOrder.items.push({
                    menu: menu,
                    quantity: 1,
                    note: ''
                });
                
                // Reduce stock
                if (menu.stock !== undefined) {
                    menu.stock--;
                }
            }
            
            // Update order and save
            updateOrder();
            saveMenus();
            
            // Play sound
            playSound('notification');
            
            // Show toast
            showToast(`${menu.name} ditambahkan ke pesanan`, 'success');
        }
        
        // Remove item from order
        function removeOrderItem() {
            const index = $(this).data('index');
            const item = currentOrder.items[index];
            
            if (!item) return;
            
            // Restore stock
            const menu = menus.find(m => m.id === item.menu.id);
            if (menu && menu.stock !== undefined) {
                menu.stock += item.quantity;
            }
            
            // Remove item
            currentOrder.items.splice(index, 1);
            
            // Update order and save
            updateOrder();
            saveMenus();
            
            // Play sound
            playSound('notification');
            
            // Show toast
            showToast(`${item.menu.name} dihapus dari pesanan`, 'info');
        }
        
        // Update item quantity
        function updateOrderItemQty() {
            const index = $(this).data('index');
            const newQty = parseInt($(this).val()) || 1;
            const item = currentOrder.items[index];
            
            if (!item || newQty < 1) return;
            
            // Calculate stock difference
            const stockDiff = newQty - item.quantity;
            
            // Update stock
            const menu = menus.find(m => m.id === item.menu.id);
            if (menu && menu.stock !== undefined) {
                menu.stock -= stockDiff;
                if (menu.stock < 0) {
                    menu.stock = 0;
                    $(this).val(item.quantity);
                    showToast(`Stok ${menu.name} tidak mencukupi!`, 'error');
                    return;
                }
            }
            
            // Update quantity
            item.quantity = newQty;
            
            // Update order and save
            updateOrder();
            saveMenus();
        }
        
        // Clear order
        function clearOrder() {
            if (currentOrder.items.length === 0) return;
            
            showConfirmation(
                'Kosongkan Pesanan',
                'Apakah Anda yakin ingin mengosongkan pesanan?',
                function() {
                    // Restore all stock
                    currentOrder.items.forEach(item => {
                        const menu = menus.find(m => m.id === item.menu.id);
                        if (menu && menu.stock !== undefined) {
                            menu.stock += item.quantity;
                        }
                    });
                    
                    // Clear order
                    currentOrder.items = [];
                    currentOrder.note = '';
                    currentOrder.memberId = null;
                    
                    // Update UI and save
                    updateOrder();
                    saveMenus();
                    
                    // Reset form fields
                    $('#orderNote').val('');
                    $('#memberSearchInput').val('');
                    $('#memberInfo').hide();
                    
                    // Play sound
                    playSound('notification');
                    
                    // Show toast
                    showToast('Pesanan berhasil dikosongkan', 'success');
                }
            );
        }
        
        // Handle menu search
        function handleMenuSearch() {
            const searchTerm = $(this).val();
            const category = $('.filter-chip.active').data('category') || 'all';
            const sortBy = $('#sortMenu').val();
            loadMenus(searchTerm, category, sortBy);
        }
        
        // Handle menu sort
        function handleMenuSort() {
            const searchTerm = $('#menuSearch').val();
            const category = $('.filter-chip.active').data('category') || 'all';
            const sortBy = $(this).val();
            loadMenus(searchTerm, category, sortBy);
        }
        
        // Handle filter click
        function handleFilterClick() {
            $('.filter-chip').removeClass('active');
            $(this).addClass('active');
            
            const searchTerm = $('#menuSearch').val();
            const category = $(this).data('category');
            const sortBy = $('#sortMenu').val();
            loadMenus(searchTerm, category, sortBy);
        }
        
        // Handle order type change
        function handleOrderTypeChange() {
            $('.order-type-btn').removeClass('active');
            $(this).addClass('active');
            
            currentOrder.type = $(this).data('type');
            $('#tableNumberContainer').toggle(currentOrder.type === 'dinein');
            updateOrder();
        }
        
        // Update table number
        function updateTableNumber() {
            currentOrder.tableNumber = $(this).val();
            updateOrder();
        }
        
        // Update order note
        function updateOrderNote() {
            currentOrder.note = $(this).val();
            updateOrder();
        }
        
        // Handle member search
        function handleMemberSearch() {
            const searchTerm = $(this).val().toLowerCase();
            const $results = $('#memberSearchResults');
            
            if (!searchTerm) {
                $results.hide().empty();
                return;
            }
            
            const filtered = members.filter(member =>
                member.name.toLowerCase().includes(searchTerm) ||
                member.id.toLowerCase().includes(searchTerm) ||
                member.phone.includes(searchTerm)
            );
            
            $results.empty();
            
            if (filtered.length === 0) {
                $results.append(`
                    <div class="member-search-item disabled">
                        <i class="fas fa-search"></i> Member tidak ditemukan
                    </div>
                `);
            } else {
                filtered.forEach(member => {
                    $results.append(`
                        <div class="member-search-item" data-id="${member.id}">
                            <strong>${member.name}</strong><br>
                            <small>${member.phone} ‚Ä¢ ${member.id}</small>
                        </div>
                    `);
                });
            }
            
            $results.show();
        }
        
        // Select member
        function selectMember() {
            const memberId = $(this).data('id');
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            $('#memberSearchInput').val(member.name);
            $('#memberSearchResults').hide();
            
            currentOrder.memberId = member.id;
            updateOrder();
            
            showToast(`Member ${member.name} dipilih`, 'success');
        }
        
        // Close member search results
        function closeMemberSearchResults(e) {
            if (!$(e.target).closest('.member-search-container').length) {
                $('#memberSearchResults').hide();
            }
        }
        
        // Open payment modal
        function openPaymentModal() {
            if (currentOrder.items.length === 0) {
                showToast('Tidak ada pesanan untuk diproses', 'warning');
                return;
            }
            
            // Update payment total
            $('#paymentTotal').text(formatCurrency(currentOrder.total));
            
            // Generate quick cash buttons
            generateQuickCashButtons();
            
            // Reset payment amount
            $('#paymentAmount').val('').trigger('input');
            
            // Update order summary in modal
            updateOrderSummaryModal();
            
            // Show modal
            $('#processOrderModal').css('display', 'flex');
            
            // Focus on payment amount
            setTimeout(() => $('#paymentAmount').focus(), 300);
        }
        
        // Generate quick cash buttons
        function generateQuickCashButtons() {
            const $container = $('#quickCashButtons').empty();
            const total = currentOrder.total;
            
            if (total <= 0) return;
            
            // Common denominations
            const denominations = [
                total, // Exact amount
                Math.ceil(total / 50000) * 50000, // Next 50k
                Math.ceil(total / 100000) * 100000, // Next 100k
                total + 50000, // Total + 50k
                total + 100000, // Total + 100k
                100000, // 100k
                200000, // 200k
                500000, // 500k
                1000000 // 1M
            ];
            
            // Remove duplicates and sort
            const uniqueDenoms = [...new Set(denominations)]
                .filter(amount => amount >= total)
                .sort((a, b) => a - b)
                .slice(0, 6); // Limit to 6 buttons
            
            uniqueDenoms.forEach(amount => {
                $container.append(`
                    <button class="quick-cash-btn" data-amount="${amount}">
                        ${amount === total ? 'Uang Pas' : formatCurrency(amount)}
                    </button>
                `);
            });
        }
        
        // Update order summary in modal
        function updateOrderSummaryModal() {
            const $summary = $('#orderSummary').empty();
            
            // Add order items
            currentOrder.items.forEach(item => {
                const total = item.menu.price * item.quantity;
                $summary.append(`
                    <div class="summary-row">
                        <span>${item.menu.name} (${item.quantity}x)</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                `);
            });
            
            // Add totals
            const discountRate = currentOrder.memberId ? 
                (members.find(m => m.id === currentOrder.memberId)?.discountRate || settings.memberDiscount) : 
                settings.nonMemberDiscount;
            
            $summary.append(`
                <div class="summary-row" style="border-top: 2px dashed #ddd; margin-top: 10px; padding-top: 10px;">
                    <span>Subtotal:</span>
                    <span>${formatCurrency(currentOrder.subtotal)}</span>
                </div>
            `);
            
            if (currentOrder.discount > 0) {
                $summary.append(`
                    <div class="summary-row">
                        <span>Diskon (${discountRate}%):</span>
                        <span class="text-success">-${formatCurrency(currentOrder.discount)}</span>
                    </div>
                `);
            }
            
            $summary.append(`
                <div class="summary-row">
                    <span>Pajak (${settings.taxRate}%):</span>
                    <span>${formatCurrency(currentOrder.tax)}</span>
                </div>
                <div class="summary-row">
                    <span>Service (${settings.serviceRate}%):</span>
                    <span>${formatCurrency(currentOrder.service)}</span>
                </div>
                <div class="summary-row total-row">
                    <span>TOTAL:</span>
                    <span>${formatCurrency(currentOrder.total)}</span>
                </div>
            `);
        }
        
        // Set quick cash amount
        function setQuickCashAmount() {
            const amount = $(this).data('amount');
            $('#paymentAmount').val(amount).trigger('input');
        }
        
        // Calculate change
        function calculateChange() {
            const amount = parseFloat($(this).val()) || 0;
            const change = amount - currentOrder.total;
            
            if (change >= 0) {
                $('#changeContainer').show();
                $('#paymentChange').text(formatCurrency(change));
                $('#completePaymentBtn').prop('disabled', false);
            } else {
                $('#changeContainer').hide();
                $('#completePaymentBtn').prop('disabled', true);
            }
        }
        
        // Complete payment
        function completePayment() {
            const paymentAmount = parseFloat($('#paymentAmount').val()) || 0;
            
            if (paymentAmount < currentOrder.total) {
                showToast('Jumlah pembayaran kurang!', 'error');
                return;
            }
            
            // Create order object
            const order = {
                id: 'ORD' + moment().format('YYYYMMDDHHmmss'),
                date: new Date().toISOString(),
                items: [...currentOrder.items],
                subtotal: currentOrder.subtotal,
                discount: currentOrder.discount,
                tax: currentOrder.tax,
                service: currentOrder.service,
                total: currentOrder.total,
                type: currentOrder.type,
                tableNumber: currentOrder.tableNumber,
                note: currentOrder.note,
                memberId: currentOrder.memberId,
                paymentMethod: $('#paymentMethod').val(),
                paymentAmount: paymentAmount,
                change: paymentAmount - currentOrder.total,
                cashier: {
                    id: currentUser.id,
                    name: currentUser.name
                },
                customerName: $('#customerName').val().trim() || 'Pelanggan',
                status: currentOrder.type === 'dinein' ? 'preparing' : 'completed',
                statusLocked: false
            };
            
            // Add to orders
            orders.unshift(order);
            saveOrders();
            
            // Update member stats if member order
            if (order.memberId) {
                const member = members.find(m => m.id === order.memberId);
                if (member) {
                    member.transactions = (member.transactions || 0) + 1;
                    member.totalSpent = (member.totalSpent || 0) + order.total;
                    saveMembers();
                }
            }
            
            // Update system stats
            system.totalTransactions = (system.totalTransactions || 0) + 1;
            system.totalRevenue = (system.totalRevenue || 0) + order.total;
            saveSystem();
            
            // Play cash sound
            playSound('cash');
            
            // Show receipt
            showReceipt(order);
            
            // Clear current order
            clearOrder();
            
            // Close modal
            $('#processOrderModal').hide();
            
            // Show success message
            showToast('Pembayaran berhasil diproses!', 'success');
            
            // Auto-print if enabled
            if (settings.autoPrint) {
                setTimeout(() => printReceipt(order), 1000);
            }
        }
        
        // Show receipt
        function showReceipt(order) {
            const member = order.memberId ? members.find(m => m.id === order.memberId) : null;
            
            let receiptHTML = `
                <div class="receipt" id="receiptContent">
                    <div class="receipt-header">
                        <h3 class="receipt-title">${settings.storeName}</h3>
                        <p>${settings.storeAddress}</p>
                        <p>Telp: ${settings.storePhone}</p>
                    </div>
                    
                    <div class="receipt-info">
                        <p><strong>No. Transaksi:</strong> ${order.id}</p>
                        <p><strong>Tanggal:</strong> ${moment(order.date).format('DD/MM/YYYY HH:mm')}</p>
                        <p><strong>Kasir:</strong> ${order.cashier.name}</p>
                        <p><strong>Pelanggan:</strong> ${order.customerName}</p>
                        <p><strong>Tipe:</strong> ${order.type === 'dinein' ? `Makan di Tempat (Meja ${order.tableNumber})` : 'Bungkus'}</p>
                        ${member ? `<p><strong>Member:</strong> ${member.name} (${member.id})</p>` : ''}
                    </div>
                    
                    <div class="receipt-items">
                        ${order.items.map(item => `
                            <div class="receipt-item">
                                <div>
                                    <strong>${item.menu.name}</strong><br>
                                    <small>${item.quantity} x ${formatCurrency(item.menu.price)}</small>
                                </div>
                                <div>${formatCurrency(item.menu.price * item.quantity)}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${order.note ? `<p style="margin: 10px 0; font-style: italic;">Catatan: ${order.note}</p>` : ''}
                    
                    <div class="receipt-total">
                        <div class="receipt-item">
                            <span>Subtotal:</span>
                            <span>${formatCurrency(order.subtotal)}</span>
                        </div>
                        ${order.discount > 0 ? `
                            <div class="receipt-item">
                                <span>Diskon:</span>
                                <span>-${formatCurrency(order.discount)}</span>
                            </div>
                        ` : ''}
                        <div class="receipt-item">
                            <span>Pajak (${settings.taxRate}%):</span>
                            <span>${formatCurrency(order.tax)}</span>
                        </div>
                        <div class="receipt-item">
                            <span>Service (${settings.serviceRate}%):</span>
                            <span>${formatCurrency(order.service)}</span>
                        </div>
                        <div class="receipt-item" style="font-size: 1.2rem;">
                            <strong>TOTAL:</strong>
                            <strong>${formatCurrency(order.total)}</strong>
                        </div>
                        <div class="receipt-item">
                            <span>${getPaymentMethodName(order.paymentMethod)}:</span>
                            <span>${formatCurrency(order.paymentAmount)}</span>
                        </div>
                        <div class="receipt-item">
                            <strong>Kembalian:</strong>
                            <strong>${formatCurrency(order.change)}</strong>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p>Terima kasih atas kunjungan Anda</p>
                        <div id="receiptQrcode" style="margin: 15px 0;"></div>
                        <p style="font-size: 0.8rem; color: #666;">
                            ${settings.storeName}<br>
                            Powered by Lentera Karya Situbondo<br>
                            www.lenterakarya.id
                        </p>
                    </div>
                </div>
            `;
            
            $('#receiptModalBody').html(receiptHTML);
            
            // Generate QR code
            const qrData = JSON.stringify({
                id: order.id,
                date: order.date,
                total: order.total,
                store: settings.storeName
            });
            
            new QRCode(document.getElementById("receiptQrcode"), {
                text: qrData,
                width: 80,
                height: 80,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Store order data for PDF download
            $('#downloadReceiptPdfBtn').data('order', order);
            
            // Show modal
            $('#receiptModal').css('display', 'flex');
        }
        
        // Get payment method name
        function getPaymentMethodName(method) {
            const methods = {
                cash: 'Tunai',
                debit: 'Kartu Debit',
                credit: 'Kartu Kredit',
                transfer: 'Transfer Bank',
                qris: 'QRIS',
                ewallet: 'E-Wallet'
            };
            return methods[method] || method;
        }
        
        // Print receipt
        function printReceipt() {
            const element = document.getElementById('receiptContent');
            if (!element) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Struk ${settings.storeName}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; }
                        .receipt { width: 300px; margin: 0 auto; }
                        .receipt-header { text-align: center; margin-bottom: 15px; }
                        .receipt-title { font-weight: bold; font-size: 1.2rem; margin: 0; }
                        .receipt-info { margin: 10px 0; font-size: 0.9rem; }
                        .receipt-item { display: flex; justify-content: space-between; margin: 5px 0; }
                        .receipt-total { margin-top: 15px; padding-top: 15px; border-top: 2px dashed #000; }
                        .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.8rem; color: #666; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    ${element.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }
        
        // Download receipt as PDF
        function downloadReceipt() {
            const order = $('#downloadReceiptPdfBtn').data('order');
            if (!order) return;
            
            showLoading('Membuat PDF...');
            
            const element = document.getElementById('receiptContent');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [80, 200]
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Struk-${order.id}-${moment(order.date).format('YYYYMMDD')}.pdf`);
                
                hideLoading();
                showToast('PDF berhasil diunduh', 'success');
            }).catch(error => {
                hideLoading();
                showToast('Gagal membuat PDF', 'error');
                console.error('PDF error:', error);
            });
        }
        
        // Send receipt via WhatsApp
        function sendReceiptWhatsApp() {
            const order = $('#downloadReceiptPdfBtn').data('order');
            if (!order) return;
            
            const message = `Struk Pembayaran - ${settings.storeName}\n\n` +
                           `No. Transaksi: ${order.id}\n` +
                           `Tanggal: ${moment(order.date).format('DD/MM/YYYY HH:mm')}\n` +
                           `Total: ${formatCurrency(order.total)}\n\n` +
                           `Terima kasih atas kunjungan Anda!\n` +
                           `${settings.storeName}\n` +
                           `${settings.storeAddress}`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
        
        // Switch modal tab
        function switchModalTab() {
            const tab = $(this).data('tab');
            const $modal = $(this).closest('.modal');
            
            $modal.find('.tabs .tab').removeClass('active');
            $modal.find('.tab-content').removeClass('active');
            
            $(this).addClass('active');
            $(`#${tab}Tab`).addClass('active');
        }
        
        // Open menu modal
        function openMenuModal(menu = null) {
            if (currentUser.role !== 'admin') return;
            
            const isEdit = menu !== null;
            
            $('#menuModal .modal-title').html(`
                <i class="fas fa-${isEdit ? 'edit' : 'plus'}"></i> 
                ${isEdit ? 'Edit Menu' : 'Tambah Menu Baru'}
            `);
            
            $('#menuForm')[0].reset();
            
            if (isEdit) {
                $('#menuId').val(menu.id);
                $('#menuName').val(menu.name);
                $('#menuCategory').val(menu.category);
                $('#menuPrice').val(menu.price);
                $('#menuImage').val(menu.image || '');
                $('#menuDescription').val(menu.description || '');
            } else {
                $('#menuId').val('');
            }
            
            loadCategories();
            $('#menuModal').css('display', 'flex');
        }
        
        // Save menu
        function saveMenu() {
            const id = $('#menuId').val();
            const name = $('#menuName').val().trim();
            const category = $('#menuCategory').val();
            const price = parseFloat($('#menuPrice').val()) || 0;
            const image = $('#menuImage').val().trim();
            const description = $('#menuDescription').val().trim();
            
            // Validation
            if (!name || !category || price <= 0) {
                showToast('Nama, kategori, dan harga harus diisi dengan benar', 'error');
                return;
            }
            
            if (id) {
                // Edit existing menu
                const index = menus.findIndex(m => m.id === id);
                if (index > -1) {
                    menus[index] = {
                        ...menus[index],
                        name,
                        category,
                        price,
                        image: image || menus[index].image,
                        description,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Add new menu
                const newMenu = {
                    id: 'M' + Date.now(),
                    name,
                    category,
                    price,
                    image,
                    description,
                    stock: 100,
                    createdAt: new Date().toISOString()
                };
                menus.unshift(newMenu);
            }
            
            saveMenus();
            loadMenus();
            $('#menuModal').hide();
            
            showToast(`Menu ${id ? 'diperbarui' : 'ditambahkan'}`, 'success');
        }
        
        // Edit menu
        function editMenu(e) {
            e.stopPropagation();
            if (currentUser.role !== 'admin') return;
            
            const menuId = $(this).data('id');
            const menu = menus.find(m => m.id === menuId);
            
            if (menu) {
                openMenuModal(menu);
            }
        }
        
        // Delete menu
        function deleteMenu(e) {
            e.stopPropagation();
            if (currentUser.role !== 'admin') return;
            
            const menuId = $(this).data('id');
            const menu = menus.find(m => m.id === menuId);
            
            if (!menu) return;
            
            promptForPassword('item', () => {
                showConfirmation(
                    'Hapus Menu',
                    `Yakin ingin menghapus menu "${menu.name}"?`,
                    () => {
                        menus = menus.filter(m => m.id !== menuId);
                        saveMenus();
                        loadMenus();
                        showToast('Menu berhasil dihapus', 'success');
                    },
                    'danger'
                );
            });
        }
        
        // Open categories modal
        function openCategoriesModal() {
            if (currentUser.role !== 'admin') return;
            
            loadCategoriesForManagement();
            $('#manageCategoriesModal').css('display', 'flex');
        }
        
        // Load categories for management
        function loadCategoriesForManagement() {
            const $list = $('#categoriesList').empty();
            
            if (categories.length === 0) {
                $list.html(`
                    <div class="empty-state">
                        <i class="fas fa-tags"></i>
                        <p>Belum ada kategori</p>
                    </div>
                `);
                return;
            }
            
            categories.forEach(category => {
                const menuCount = menus.filter(m => m.category === category.name).length;
                $list.append(`
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">
                                <i class="${category.icon}" style="color: ${category.color};"></i>
                                ${category.name}
                            </div>
                            <div class="order-item-price">
                                ${menuCount} menu
                            </div>
                        </div>
                        <div class="order-item-qty">
                            <button class="remove-btn remove-category" data-id="${category.id}" title="Hapus Kategori">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
        }
        
        // Add category
        function addCategory() {
            const name = $('#newCategoryName').val().trim();
            
            if (!name) {
                showToast('Nama kategori harus diisi', 'error');
                return;
            }
            
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showToast('Kategori sudah ada', 'error');
                return;
            }
            
            // Default colors and icons
            const colors = ['#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#e74c3c', '#1abc9c'];
            const icons = ['fas fa-utensils', 'fas fa-glass-whiskey', 'fas fa-cookie', 
                          'fas fa-ice-cream', 'fas fa-coffee', 'fas fa-hamburger'];
            
            const newCategory = {
                id: 'C' + Date.now(),
                name,
                color: colors[categories.length % colors.length],
                icon: icons[categories.length % icons.length],
                createdAt: new Date().toISOString()
            };
            
            categories.push(newCategory);
            saveCategories();
            loadCategories();
            loadCategoriesForManagement();
            
            $('#newCategoryName').val('');
            showToast('Kategori ditambahkan', 'success');
        }
        
        // Remove category
        function removeCategory() {
            if (currentUser.role !== 'admin') return;
            
            const categoryId = $(this).data('id');
            const category = categories.find(c => c.id === categoryId);
            
            if (!category) return;
            
            // Check if category is being used
            const isUsed = menus.some(m => m.category === category.name);
            
            if (isUsed) {
                showToast('Kategori sedang digunakan oleh beberapa menu', 'error');
                return;
            }
            
            promptForPassword('item', () => {
                showConfirmation(
                    'Hapus Kategori',
                    `Yakin ingin menghapus kategori "${category.name}"?`,
                    () => {
                        categories = categories.filter(c => c.id !== categoryId);
                        saveCategories();
                        loadCategories();
                        loadCategoriesForManagement();
                        showToast('Kategori dihapus', 'success');
                    },
                    'danger'
                );
            });
        }
        
        // Open reports modal
        function openReportsModal() {
            if (currentUser.role !== 'admin') return;
            
            $('#reportsModal .tabs .tab').removeClass('active').first().addClass('active');
            $('#reportsModal .tab-content').removeClass('active').first().addClass('active');
            
            $('#reportPeriod').val('today').trigger('change');
            $('#reportResults, #productResults, #memberReportResults').empty();
            $('#printReportBtn, #downloadReportBtn').hide();
            
            $('#reportsModal').css('display', 'flex');
        }
        
        // Toggle custom date range
        function toggleCustomDateRange() {
            const isCustom = $(this).val() === 'custom';
            $('#customDateRange').toggle(isCustom);
        }
        
        // Generate report
        function generateReport() {
            const period = $('#reportPeriod').val();
            const tab = $('#reportsModal .tabs .tab.active').data('tab');
            
            switch (tab) {
                case 'salesReport':
                    generateSalesReport(period);
                    break;
                case 'productReport':
                    generateProductReport();
                    break;
                case 'memberReport':
                    generateMemberReport();
                    break;
            }
        }
        
        // Generate sales report
        function generateSalesReport(period) {
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = moment().startOf('day');
                    endDate = moment().endOf('day');
                    break;
                case 'yesterday':
                    startDate = moment().subtract(1, 'day').startOf('day');
                    endDate = moment().subtract(1, 'day').endOf('day');
                    break;
                case 'week':
                    startDate = moment().startOf('week');
                    endDate = moment().endOf('week');
                    break;
                case 'month':
                    startDate = moment().startOf('month');
                    endDate = moment().endOf('month');
                    break;
                case 'last_month':
                    startDate = moment().subtract(1, 'month').startOf('month');
                    endDate = moment().subtract(1, 'month').endOf('month');
                    break;
                case 'year':
                    startDate = moment().startOf('year');
                    endDate = moment().endOf('year');
                    break;
                case 'custom':
                    startDate = moment($('#reportStartDate').val());
                    endDate = moment($('#reportEndDate').val());
                    if (!startDate.isValid() || !endDate.isValid()) {
                        showToast('Tanggal tidak valid', 'error');
                        return;
                    }
                    break;
            }
            
            // Filter orders by date
            const filteredOrders = orders.filter(order => {
                const orderDate = moment(order.date);
                return orderDate.isBetween(startDate, endDate, null, '[]');
            });
            
            // Calculate statistics
            const totalOrders = filteredOrders.length;
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total, 0);
            const totalItems = filteredOrders.reduce((sum, order) => {
                return sum + order.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
            }, 0);
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            // Group by payment method
            const paymentMethods = {};
            filteredOrders.forEach(order => {
                const method = order.paymentMethod || 'cash';
                paymentMethods[method] = (paymentMethods[method] || 0) + 1;
            });
            
            // Generate report HTML
            let reportHTML = `
                <div class="panel">
                    <h4 class="panel-title">
                        <i class="fas fa-chart-line"></i> 
                        Laporan Penjualan ${period === 'custom' ? 
                            `${startDate.format('DD/MM/YYYY')} - ${endDate.format('DD/MM/YYYY')}` : 
                            period.charAt(0).toUpperCase() + period.slice(1)
                        }
                    </h4>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-shopping-cart fa-2x" style="color: var(--secondary);"></i>
                            <div class="stat-value">${totalOrders}</div>
                            <div class="stat-label">Total Transaksi</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave fa-2x" style="color: var(--success);"></i>
                            <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                            <div class="stat-label">Total Pendapatan</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-boxes fa-2x" style="color: var(--warning);"></i>
                            <div class="stat-value">${totalItems}</div>
                            <div class="stat-label">Total Item Terjual</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-bar fa-2x" style="color: var(--info);"></i>
                            <div class="stat-value">${formatCurrency(avgOrderValue)}</div>
                            <div class="stat-label">Rata-rata per Transaksi</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5><i class="fas fa-credit-card"></i> Metode Pembayaran</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
            `;
            
            Object.entries(paymentMethods).forEach(([method, count]) => {
                const percentage = ((count / totalOrders) * 100).toFixed(1);
                reportHTML += `
                    <div class="p-2 rounded" style="background: var(--light); border-left: 4px solid var(--secondary);">
                        <div><strong>${getPaymentMethodName(method)}</strong></div>
                        <div>${count} transaksi (${percentage}%)</div>
                    </div>
                `;
            });
            
            reportHTML += `
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5><i class="fas fa-list"></i> Detail Transaksi</h5>
                        <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
            `;
            
            if (filteredOrders.length === 0) {
                reportHTML += '<p class="text-center text-muted">Tidak ada transaksi</p>';
            } else {
                filteredOrders.forEach(order => {
                    reportHTML += `
                        <div class="order-item">
                            <div class="order-item-info">
                                <div class="order-item-name">${order.id}</div>
                                <div class="order-item-price">
                                    ${moment(order.date).format('DD/MM HH:mm')} | 
                                    ${order.customerName} | 
                                    ${formatCurrency(order.total)}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            reportHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            $('#reportResults').html(reportHTML);
            $('#printReportBtn, #downloadReportBtn').show();
        }
        
        // Generate product report
        function generateProductReport() {
            const filter = $('#productFilter').val();
            let productStats = {};
            
            // Collect product statistics from all orders
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!productStats[item.menu.id]) {
                        productStats[item.menu.id] = {
                            name: item.menu.name,
                            category: item.menu.category,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productStats[item.menu.id].quantity += item.quantity;
                    productStats[item.menu.id].revenue += item.menu.price * item.quantity;
                });
            });
            
            // Convert to array and sort
            let productArray = Object.values(productStats);
            
            switch (filter) {
                case 'top10':
                    productArray.sort((a, b) => b.quantity - a.quantity);
                    productArray = productArray.slice(0, 10);
                    break;
                case 'least10':
                    productArray.sort((a, b) => a.quantity - b.quantity);
                    productArray = productArray.slice(0, 10);
                    break;
                case 'category':
                    // Group by category
                    const byCategory = {};
                    productArray.forEach(product => {
                        if (!byCategory[product.category]) {
                            byCategory[product.category] = [];
                        }
                        byCategory[product.category].push(product);
                    });
                    // Flatten array by category
                    productArray = [];
                    Object.values(byCategory).forEach(categoryProducts => {
                        productArray.push(...categoryProducts);
                    });
                    break;
                // 'all' - no sorting needed
            }
            
            // Generate report HTML
            let reportHTML = `
                <div class="panel">
                    <h4 class="panel-title">
                        <i class="fas fa-utensils"></i> Laporan Produk
                    </h4>
                    
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th>Kategori</th>
                                    <th>Terjual</th>
                                    <th>Pendapatan</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (productArray.length === 0) {
                reportHTML += `
                    <tr>
                        <td colspan="4" class="text-center">Belum ada data penjualan produk</td>
                    </tr>
                `;
            } else {
                productArray.forEach(product => {
                    reportHTML += `
                        <tr>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>${product.quantity}</td>
                            <td>${formatCurrency(product.revenue)}</td>
                        </tr>
                    `;
                });
            }
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            $('#productResults').html(reportHTML);
        }
        
        // Generate member report
        function generateMemberReport() {
            // Sort members by total spent
            const sortedMembers = [...members].sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));
            
            let reportHTML = `
                <div class="panel">
                    <h4 class="panel-title">
                        <i class="fas fa-users"></i> Laporan Member
                    </h4>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x" style="color: var(--secondary);"></i>
                            <div class="stat-value">${members.length}</div>
                            <div class="stat-label">Total Member</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-shopping-cart fa-2x" style="color: var(--success);"></i>
                            <div class="stat-value">${members.reduce((sum, m) => sum + (m.transactions || 0), 0)}</div>
                            <div class="stat-label">Total Transaksi</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave fa-2x" style="color: var(--warning);"></i>
                            <div class="stat-value">${formatCurrency(members.reduce((sum, m) => sum + (m.totalSpent || 0), 0))}</div>
                            <div class="stat-label">Total Belanja</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-percentage fa-2x" style="color: var(--info);"></i>
                            <div class="stat-value">${members.length > 0 ? 
                                Math.round(members.reduce((sum, m) => sum + (m.discountRate || 0), 0) / members.length) : 0
                            }%</div>
                            <div class="stat-label">Rata-rata Diskon</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5><i class="fas fa-crown"></i> Top Member</h5>
                        <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
            `;
            
            if (sortedMembers.length === 0) {
                reportHTML += '<p class="text-center text-muted">Belum ada member</p>';
            } else {
                sortedMembers.slice(0, 10).forEach((member, index) => {
                    reportHTML += `
                        <div class="order-item">
                            <div class="order-item-info">
                                <div class="order-item-name">
                                    ${index + 1}. ${member.name}
                                    <span class="badge badge-success">${member.discountRate || 0}% diskon</span>
                                </div>
                                <div class="order-item-price">
                                    ${member.transactions || 0} transaksi | 
                                    ${formatCurrency(member.totalSpent || 0)}
                                </div>
                            </div>
                            <div class="order-item-qty">
                                <button class="btn btn-sm btn-info kta-member" data-id="${member.id}">
                                    <i class="fas fa-id-card"></i> Kartu
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            reportHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            $('#memberReportResults').html(reportHTML);
        }
        
        // Download report as PDF
        function downloadReport() {
            const tab = $('#reportsModal .tabs .tab.active').data('tab');
            const element = document.querySelector(`#${tab}Tab .panel`);
            
            if (!element) {
                showToast('Tidak ada laporan untuk diunduh', 'error');
                return;
            }
            
            showLoading('Membuat PDF...');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                pdf.save(`Laporan-${tab}-${moment().format('YYYYMMDD')}.pdf`);
                
                hideLoading();
                showToast('PDF berhasil diunduh', 'success');
            }).catch(error => {
                hideLoading();
                showToast('Gagal membuat PDF', 'error');
                console.error('PDF error:', error);
            });
        }
        
        // Print report
        function printReport() {
            const tab = $('#reportsModal .tabs .tab.active').data('tab');
            const element = document.querySelector(`#${tab}Tab .panel`);
            
            if (!element) {
                showToast('Tidak ada laporan untuk dicetak', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Laporan ${settings.storeName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .panel { border: 1px solid #ddd; border-radius: 5px; padding: 20px; }
                        .panel-title { border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                        .stat-card { text-align: center; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
                        .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
                        .stat-label { color: #666; font-size: 12px; text-transform: uppercase; }
                        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .data-table th, .data-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
                        .data-table th { background: #f8f9fa; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2>${settings.storeName}</h2>
                        <p>${settings.storeAddress} | ${settings.storePhone}</p>
                        <h3>Laporan ${tab === 'salesReport' ? 'Penjualan' : tab === 'productReport' ? 'Produk' : 'Member'}</h3>
                        <p>${moment().format('DD MMMM YYYY HH:mm')}</p>
                    </div>
                    ${element.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }
        
        // Open history modal
        function openHistoryModal() {
            if (currentUser.role !== 'admin') return;
            
            loadTransactionHistory();
            $('#historyModal').css('display', 'flex');
        }
        
        // Load transaction history
        function loadTransactionHistory() {
            const searchTerm = $('#historySearchInput').val().toLowerCase();
            const filter = $('#historyFilter').val();
            const sort = $('#historySort').val();
            
            let filteredOrders = [...orders];
            
            // Apply search filter
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order =>
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    (order.memberId && order.memberId.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply time filter
            if (filter !== 'all') {
                const now = moment();
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = moment(order.date);
                    
                    switch (filter) {
                        case 'today':
                            return orderDate.isSame(now, 'day');
                        case 'week':
                            return orderDate.isSame(now, 'week');
                        case 'month':
                            return orderDate.isSame(now, 'month');
                        default:
                            return true;
                    }
                });
            }
            
            // Apply sorting
            switch (sort) {
                case 'newest':
                    filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'oldest':
                    filteredOrders.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'highest':
                    filteredOrders.sort((a, b) => b.total - a.total);
                    break;
                case 'lowest':
                    filteredOrders.sort((a, b) => a.total - b.total);
                    break;
            }
            
            // Display results
            const $results = $('#historyResults').empty();
            
            if (filteredOrders.length === 0) {
                $results.html(`
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>Tidak ada transaksi ditemukan</p>
                    </div>
                `);
                return;
            }
            
            filteredOrders.forEach(order => {
                const member = order.memberId ? members.find(m => m.id === order.memberId) : null;
                
                $results.append(`
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">
                                ${order.id}
                                ${member ? `<span class="badge badge-info">Member</span>` : ''}
                            </div>
                            <div class="order-item-price">
                                ${moment(order.date).format('DD MMM YYYY, HH:mm')} | 
                                ${order.customerName} | 
                                ${order.type === 'dinein' ? `Meja ${order.tableNumber}` : 'Bungkus'} | 
                                <strong>${formatCurrency(order.total)}</strong>
                            </div>
                        </div>
                        <div class="order-item-qty">
                            <button class="btn btn-sm btn-info reprint-receipt" data-id="${order.id}">
                                <i class="fas fa-print"></i> Cetak Ulang
                            </button>
                        </div>
                    </div>
                `);
            });
        }
        
        // Handle history search
        function handleHistorySearch() {
            loadTransactionHistory();
        }
        
        // Print history
        function printHistory() {
            const element = document.getElementById('historyResults');
            if (!element) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Histori Transaksi ${settings.storeName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .order-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
                        .order-item-info { flex: 1; }
                        .order-item-name { font-weight: bold; }
                        .order-item-price { color: #666; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2>${settings.storeName}</h2>
                        <p>Histori Transaksi - ${moment().format('DD MMMM YYYY HH:mm')}</p>
                    </div>
                    ${element.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }
        
        // Download history as PDF
        function downloadHistory() {
            const element = document.getElementById('historyResults');
            if (!element) {
                showToast('Tidak ada data untuk diunduh', 'error');
                return;
            }
            
            showLoading('Membuat PDF...');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                pdf.save(`Histori-Transaksi-${moment().format('YYYYMMDD')}.pdf`);
                
                hideLoading();
                showToast('PDF berhasil diunduh', 'success');
            }).catch(error => {
                hideLoading();
                showToast('Gagal membuat PDF', 'error');
                console.error('PDF error:', error);
            });
        }
        
        // Reprint receipt
        function reprintReceipt() {
            const orderId = $(this).data('id');
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                showReceipt(order);
            }
        }
        
        // Open kitchen modal
        function openKitchenModal() {
            loadKitchenOrders();
            
            // Start auto-refresh
            if (kitchenInterval) clearInterval(kitchenInterval);
            kitchenInterval = setInterval(loadKitchenOrders, 30000);
            
            $('#kitchenDisplayModal').css('display', 'flex');
        }
        
        // Load kitchen orders
        function loadKitchenOrders() {
            const kitchenOrders = orders.filter(o => o.type === 'dinein' && o.status !== 'completed');
            const $kitchenOrders = $('#kitchenOrders').empty();
            
            $('#kitchenOrderCount').text(kitchenOrders.length);
            
            if (kitchenOrders.length === 0) {
                $kitchenOrders.html(`
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>Tidak ada pesanan dapur</p>
                    </div>
                `);
                return;
            }
            
            kitchenOrders.forEach(order => {
                const statusClass = order.status === 'ready' ? 
                    (order.statusLocked ? 'status-locked' : 'status-ready') : 
                    'status-preparing';
                
                const itemsText = order.items.slice(0, 2).map(item => 
                    `${item.menu.name} (${item.quantity}x)`
                ).join(', ') + (order.items.length > 2 ? ` + ${order.items.length - 2} lainnya` : '');
                
                $kitchenOrders.append(`
                    <div class="status-item ${statusClass}" data-id="${order.id}">
                        <div>
                            <strong>${order.id} (Meja ${order.tableNumber})</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${itemsText}
                                ${order.note ? `<br><em>Note: ${order.note}</em>` : ''}
                            </div>
                        </div>
                        <div style="font-weight: 600; font-size: 1.1rem;">
                            ${order.status === 'ready' ? '‚úÖ Siap' : '‚è≥ Proses'}
                        </div>
                    </div>
                `);
            });
        }
        
        // Toggle order status
        function toggleOrderStatus() {
            const orderId = $(this).data('id');
            const order = orders.find(o => o.id === orderId);
            
            if (!order || order.statusLocked) return;
            
            order.status = order.status === 'preparing' ? 'ready' : 'preparing';
            
            if (order.status === 'ready') {
                order.statusLocked = true;
                playSound('notification');
            }
            
            saveOrders();
            loadKitchenOrders();
            
            showToast(`Status pesanan ${order.id} diperbarui`, 'success');
        }
        
        // Clear completed orders
        function clearCompletedOrders() {
            showConfirmation(
                'Bersihkan Pesanan Selesai',
                'Yakin ingin menghapus semua pesanan yang sudah selesai?',
                () => {
                    // Mark completed orders as completed
                    orders.forEach(order => {
                        if (order.type === 'dinein' && order.status === 'ready') {
                            order.status = 'completed';
                        }
                    });
                    
                    saveOrders();
                    loadKitchenOrders();
                    showToast('Pesanan selesai dibersihkan', 'success');
                }
            );
        }
        
        // Open members modal
        function openMembersModal() {
            if (currentUser.role !== 'admin') return;
            
            resetMemberForm();
            loadMembersForManagement();
            $('#memberAdminFields').toggle(currentUser.role === 'admin');
            $('#manageMembersModal').css('display', 'flex');
        }
        
        // Load members for management
        function loadMembersForManagement(searchTerm = '') {
            const $list = $('#membersList').empty();
            const term = searchTerm.toLowerCase();
            
            const filteredMembers = members.filter(member =>
                !searchTerm ||
                member.name.toLowerCase().includes(term) ||
                member.id.toLowerCase().includes(term) ||
                member.phone.includes(term)
            );
            
            if (filteredMembers.length === 0) {
                $list.html(`
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Member tidak ditemukan</p>
                    </div>
                `);
                return;
            }
            
            filteredMembers.forEach(member => {
                $list.append(`
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">
                                ${member.name}
                                <span class="badge badge-success">${member.discountRate || 0}% diskon</span>
                            </div>
                            <div class="order-item-price">
                                ${member.phone} | ${member.id}
                                <br>
                                <small>
                                    ${member.transactions || 0} transaksi | 
                                    ${formatCurrency(member.totalSpent || 0)}
                                </small>
                            </div>
                        </div>
                        <div class="order-item-qty gap-2">
                            <button class="btn btn-sm btn-info kta-member" data-id="${member.id}" title="Kartu Member">
                                <i class="fas fa-id-card"></i>
                            </button>
                            <button class="btn btn-sm btn-warning edit-member" data-id="${member.id}" title="Edit Member">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
        }
        
        // Show member form
        function showMemberForm() {
            $('#memberFormContainer').slideDown();
        }
        
        // Hide member form
        function hideMemberForm() {
            $('#memberFormContainer').slideUp();
            resetMemberForm();
        }
        
        // Reset member form
        function resetMemberForm() {
            $('#memberForm')[0].reset();
            $('#memberIdInput').val('');
            $('#memberFormTitle').html('<i class="fas fa-user-plus"></i> Tambah Member Baru');
            $('#saveMemberBtn').html('<i class="fas fa-save"></i> Tambah Member');
            $('#deleteMemberBtn').hide();
        }
        
        // Save member
        function saveMember(e) {
            e.preventDefault();
            
            const id = $('#memberIdInput').val();
            const name = $('#memberName').val().trim();
            const phone = $('#memberPhone').val().trim();
            const address = $('#memberAddress').val().trim();
            
            if (!name || !phone) {
                showToast('Nama dan nomor telepon harus diisi', 'error');
                return;
            }
            
            if (id) {
                // Update existing member
                const index = members.findIndex(m => m.id === id);
                if (index > -1) {
                    members[index] = {
                        ...members[index],
                        name,
                        phone,
                        address,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Add new member
                const newMember = {
                    id: 'MEM' + Date.now(),
                    name,
                    phone,
                    address,
                    joinDate: new Date().toISOString(),
                    transactions: 0,
                    totalSpent: 0,
                    discountRate: settings.memberDiscount,
                    status: 'active'
                };
                members.unshift(newMember);
            }
            
            saveMembers();
            loadMembersForManagement();
            hideMemberForm();
            
            showToast(`Member ${id ? 'diperbarui' : 'ditambahkan'}`, 'success');
        }
        
        // Edit member
        function editMember() {
            const memberId = $(this).data('id');
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            $('#memberFormTitle').html('<i class="fas fa-user-edit"></i> Edit Member');
            $('#memberIdInput').val(member.id);
            $('#memberName').val(member.name);
            $('#memberPhone').val(member.phone);
            $('#memberAddress').val(member.address || '');
            $('#memberTransactions').val(member.transactions || 0);
            $('#memberTotalSpent').val(formatCurrency(member.totalSpent || 0));
            $('#saveMemberBtn').html('<i class="fas fa-save"></i> Simpan Perubahan');
            $('#deleteMemberBtn').show().data('id', member.id);
            $('#memberFormContainer').slideDown();
        }
        
        // Delete member
        function deleteMember() {
            const memberId = $('#deleteMemberBtn').data('id');
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            promptForPassword('item', () => {
                showConfirmation(
                    'Hapus Member',
                    `Yakin ingin menghapus member "${member.name}"?`,
                    () => {
                        members = members.filter(m => m.id !== memberId);
                        saveMembers();
                        loadMembersForManagement();
                        hideMemberForm();
                        showToast('Member dihapus', 'success');
                    },
                    'danger'
                );
            });
        }
        
        // Open KTA modal
        function openKtaModal(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // Generate KTA card HTML
            const ktaHTML = `
                <div id="ktaCard" style="
                    width: 350px;
                    height: 500px;
                    margin: 0 auto;
                    border-radius: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 30px;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    position: relative;
                    overflow: hidden;
                ">
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; 
                         background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -80px; left: -80px; width: 250px; height: 250px; 
                         background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                    
                    <div style="text-align: center; margin-bottom: 30px; position: relative; z-index: 1;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">${settings.storeName}</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Member Card</p>
                    </div>
                    
                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; 
                         align-items: center; text-align: center; position: relative; z-index: 1;">
                        <div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.2); 
                             display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                            <i class="fas fa-user" style="font-size: 50px;"></i>
                        </div>
                        
                        <h3 style="font-size: 28px; margin: 0 0 10px 0; font-weight: 600;">${member.name}</h3>
                        <p style="background: rgba(0,0,0,0.3); padding: 8px 20px; border-radius: 20px; 
                           font-family: 'Courier New', monospace; letter-spacing: 2px;">
                           ${member.id}
                        </p>
                        
                        <div style="margin: 30px 0; background: white; padding: 15px; border-radius: 10px;">
                            <div id="ktaQrcodeImg"></div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; font-size: 11px; opacity: 0.8; position: relative; z-index: 1;">
                        <p>Member sejak ${moment(member.joinDate).format('DD MMM YYYY')}</p>
                        <p>Diskon ${member.discountRate || 0}% ‚Ä¢ ${member.transactions || 0} transaksi</p>
                    </div>
                </div>
            `;
            
            $('#ktaModalBody').html(ktaHTML);
            
            // Generate QR code
            const qrData = JSON.stringify({
                memberId: member.id,
                name: member.name,
                phone: member.phone,
                store: settings.storeName,
                joinDate: member.joinDate
            });
            
            new QRCode(document.getElementById("ktaQrcodeImg"), {
                text: qrData,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Store member data for PDF
            $('#downloadKtaPdfBtn').data('member', member);
            
            // Show modal
            $('#ktaModal').css('display', 'flex');
        }
        
        // Download KTA as PDF
        function downloadKta() {
            const member = $('#downloadKtaPdfBtn').data('member');
            if (!member) return;
            
            showLoading('Membuat kartu member...');
            
            const element = document.getElementById('ktaCard');
            
            html2canvas(element, {
                scale: 3,
                useCORS: true,
                logging: false,
                backgroundColor: null
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [90, 130]
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`KTA-${member.name.replace(/\s+/g, '-')}-${member.id}.pdf`);
                
                hideLoading();
                showToast('Kartu member berhasil diunduh', 'success');
            }).catch(error => {
                hideLoading();
                showToast('Gagal membuat kartu member', 'error');
                console.error('KTA PDF error:', error);
            });
        }
        
        // Print KTA
        function printKta() {
            const element = document.getElementById('ktaCard');
            if (!element) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Kartu Member ${settings.storeName}</title>
                    <style>
                        @media print {
                            body { margin: 0; padding: 0; }
                            @page { size: 90mm 130mm; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${element.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }
        
        // Open store info modal
        function openStoreInfoModal() {
            if (currentUser.role !== 'admin') return;
            
            loadStoreInfo();
            $('#manageStoreInfoModal').css('display', 'flex');
        }
        
        // Load store info
        function loadStoreInfo() {
            $('#storeName').val(settings.storeName || '');
            $('#storeAddress').val(settings.storeAddress || '');
            $('#storePhone').val(settings.storePhone || '');
            $('#storeEmail').val(settings.storeEmail || '');
            $('#tableCount').val(settings.tableCount || 10);
            $('#storeTax').val(settings.taxRate || 10);
            $('#storeService').val(settings.serviceRate || 5);
        }
        
        // Save store info
        function saveStoreInfo(e) {
            e.preventDefault();
            
            settings.storeName = $('#storeName').val().trim();
            settings.storeAddress = $('#storeAddress').val().trim();
            settings.storePhone = $('#storePhone').val().trim();
            settings.storeEmail = $('#storeEmail').val().trim();
            settings.tableCount = parseInt($('#tableCount').val()) || 10;
            settings.taxRate = parseFloat($('#storeTax').val()) || 10;
            settings.serviceRate = parseFloat($('#storeService').val()) || 5;
            
            saveSettings();
            updateStoreInfo();
            updateTableNumbers();
            
            $('#manageStoreInfoModal').hide();
            showToast('Informasi restoran berhasil disimpan', 'success');
        }
        
        // Update store info in UI
        function updateStoreInfo() {
            $('#storeNameHeader').text(settings.storeName || 'CAFE & RESTO POS');
            document.title = settings.storeName || 'CAFE & RESTO POS SYSTEM';
        }
        
        // Update table numbers
        function updateTableNumbers() {
            const $select = $('#tableNumber').empty();
            const count = settings.tableCount || 10;
            
            for (let i = 1; i <= count; i++) {
                $select.append(`<option value="${i}">Meja ${i}</option>`);
            }
            
            $select.val(currentOrder.tableNumber || '1');
        }
        
        // Open control panel
        function openControlPanel() {
            if (currentUser.role !== 'admin') return;
            
            promptForPassword('panel', () => {
                $('#controlPanelModal .tabs .tab').removeClass('active').first().addClass('active');
                $('#controlPanelModal .tab-content').removeClass('active').first().addClass('active');
                
                loadUsersForManagement();
                loadSecuritySettings();
                
                $('#controlPanelModal').css('display', 'flex');
            });
        }
        
        // Load users for management
        function loadUsersForManagement() {
            const $list = $('#usersList').empty();
            
            if (users.length === 0) {
                $list.html(`
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Tidak ada pengguna</p>
                    </div>
                `);
                return;
            }
            
            users.forEach(user => {
                $list.append(`
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">
                                ${user.name}
                                <span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-info'}">
                                    ${user.role === 'admin' ? 'Administrator' : user.role === 'kitchen' ? 'Dapur' : 'Kasir'}
                                </span>
                            </div>
                            <div class="order-item-price">
                                ${user.username}
                            </div>
                        </div>
                        <div class="order-item-qty gap-2">
                            <button class="btn btn-sm btn-warning edit-user" data-id="${user.id}" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${user.id !== currentUser.id ? `
                                <button class="btn btn-sm btn-danger delete-user" data-id="${user.id}" title="Hapus User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `);
            });
        }
        
        // Load security settings
        function loadSecuritySettings() {
            $('#memberDiscount').val(settings.memberDiscount || 10);
            $('#nonMemberDiscount').val(settings.nonMemberDiscount || 0);
            $('#soundNotifications').prop('checked', settings.soundNotifications !== false);
            $('#autoSave').prop('checked', settings.autoSave !== false);
            $('#autoPrint').prop('checked', settings.autoPrint === true);
            $('#themeSelect').val(settings.theme || 'default');
        }
        
        // Show user form
        function showUserForm() {
            $('#userFormContainer').slideDown();
        }
        
        // Hide user form
        function hideUserForm() {
            $('#userFormContainer').slideUp();
            resetUserForm();
        }
        
        // Reset user form
        function resetUserForm() {
            $('#userForm')[0].reset();
            $('#userIdInput').val('');
            $('#userFormTitle').html('<i class="fas fa-user-plus"></i> Tambah Pengguna');
            $('#userUsername').prop('disabled', false);
        }
        
        // Save user
        function saveUser(e) {
            e.preventDefault();
            
            const id = $('#userIdInput').val();
            const name = $('#userName').val().trim();
            const username = $('#userUsername').val().trim();
            const password = $('#userPassword').val();
            const role = $('#userRole').val();
            
            if (!name || !username) {
                showToast('Nama dan username harus diisi', 'error');
                return;
            }
            
            if (id) {
                // Update existing user
                const index = users.findIndex(u => u.id === id);
                if (index > -1) {
                    users[index].name = name;
                    users[index].role = role;
                    
                    if (password) {
                        users[index].password = CryptoJS.SHA256(password).toString();
                    }
                    
                    users[index].updatedAt = new Date().toISOString();
                }
            } else {
                // Add new user
                if (!password) {
                    showToast('Password harus diisi untuk pengguna baru', 'error');
                    return;
                }
                
                if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                    showToast('Username sudah digunakan', 'error');
                    return;
                }
                
                const newUser = {
                    id: 'U' + Date.now(),
                    username,
                    password: CryptoJS.SHA256(password).toString(),
                    name,
                    role,
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
            }
            
            saveUsers();
            loadUsersForManagement();
            hideUserForm();
            
            showToast(`Pengguna ${id ? 'diperbarui' : 'ditambahkan'}`, 'success');
        }
        
        // Edit user
        function editUser() {
            const userId = $(this).data('id');
            const user = users.find(u => u.id === userId);
            
            if (!user) return;
            
            $('#userFormTitle').html('<i class="fas fa-user-edit"></i> Edit Pengguna');
            $('#userIdInput').val(user.id);
            $('#userName').val(user.name);
            $('#userUsername').val(user.username).prop('disabled', true);
            $('#userRole').val(user.role);
            $('#userPassword').val('');
            $('#userFormContainer').slideDown();
        }
        
        // Delete user
        function deleteUser() {
            const userId = $(this).data('id');
            const user = users.find(u => u.id === userId);
            
            if (!user) return;
            
            if (users.length <= 1) {
                showToast('Tidak dapat menghapus satu-satunya pengguna', 'error');
                return;
            }
            
            if (userId === currentUser.id) {
                showToast('Tidak dapat menghapus akun sendiri', 'error');
                return;
            }
            
            showConfirmation(
                'Hapus Pengguna',
                `Yakin ingin menghapus pengguna "${user.name}"?`,
                () => {
                    users = users.filter(u => u.id !== userId);
                    saveUsers();
                    loadUsersForManagement();
                    showToast('Pengguna dihapus', 'success');
                },
                'danger'
            );
        }
        
        // Change item security code
        function changeItemSecurity(e) {
            e.preventDefault();
            
            const newPassword = $('#itemSecurityCode').val();
            
            if (newPassword.length < 4) {
                showToast('Password minimal 4 karakter', 'error');
                return;
            }
            
            settings.itemSecurityCode = CryptoJS.SHA256(newPassword).toString();
            saveSettings();
            
            $('#itemSecurityForm')[0].reset();
            showToast('Password keamanan item berhasil diubah', 'success');
        }
        
        // Change panel security code
        function changePanelSecurity(e) {
            e.preventDefault();
            
            const newPassword = $('#panelSecurityCode').val();
            
            if (newPassword.length < 4) {
                showToast('Password minimal 4 karakter', 'error');
                return;
            }
            
            settings.panelSecurityCode = CryptoJS.SHA256(newPassword).toString();
            saveSettings();
            
            $('#panelSecurityForm')[0].reset();
            showToast('Password keamanan panel berhasil diubah', 'success');
        }
        
        // Save discount settings
        function saveDiscountSettings(e) {
            e.preventDefault();
            
            const memberDiscount = parseFloat($('#memberDiscount').val()) || 0;
            const nonMemberDiscount = parseFloat($('#nonMemberDiscount').val()) || 0;
            
            if (memberDiscount < 0 || memberDiscount > 100 || nonMemberDiscount < 0 || nonMemberDiscount > 100) {
                showToast('Diskon harus antara 0-100%', 'error');
                return;
            }
            
            settings.memberDiscount = memberDiscount;
            settings.nonMemberDiscount = nonMemberDiscount;
            
            // Update existing members' discount rates
            members.forEach(member => {
                if (member.discountRate === undefined || member.discountRate === settings.memberDiscount) {
                    member.discountRate = memberDiscount;
                }
            });
            
            saveSettings();
            saveMembers();
            showToast('Pengaturan diskon berhasil disimpan', 'success');
        }
        
        // Change own password
        function changeOwnPassword(e) {
            e.preventDefault();
            
            const currentPass = $('#currentPassword').val();
            const newPass = $('#newPassword').val();
            
            if (CryptoJS.SHA256(currentPass).toString() !== currentUser.password) {
                showToast('Password saat ini salah', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showToast('Password baru minimal 6 karakter', 'error');
                return;
            }
            
            // Update current user
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex > -1) {
                users[userIndex].password = CryptoJS.SHA256(newPass).toString();
                currentUser.password = users[userIndex].password;
                
                saveUsers();
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(currentUser));
                
                $('#changeOwnPasswordForm')[0].reset();
                showToast('Password berhasil diubah', 'success');
            }
        }
        
        // Save system settings
        function saveSystemSettings(e) {
            e.preventDefault();
            
            settings.soundNotifications = $('#soundNotifications').is(':checked');
            settings.autoSave = $('#autoSave').is(':checked');
            settings.autoPrint = $('#autoPrint').is(':checked');
            settings.theme = $('#themeSelect').val();
            
            saveSettings();
            applyTheme(settings.theme);
            
            showToast('Pengaturan sistem berhasil disimpan', 'success');
        }
        
        // Apply theme
        function applyTheme(theme) {
            const root = document.documentElement;
            
            switch (theme) {
                case 'green':
                    root.style.setProperty('--primary', '#27ae60');
                    root.style.setProperty('--secondary', '#2ecc71');
                    break;
                case 'red':
                    root.style.setProperty('--primary', '#c0392b');
                    root.style.setProperty('--secondary', '#e74c3c');
                    break;
                case 'purple':
                    root.style.setProperty('--primary', '#8e44ad');
                    root.style.setProperty('--secondary', '#9b59b6');
                    break;
                case 'dark':
                    root.style.setProperty('--primary', '#2c3e50');
                    root.style.setProperty('--secondary', '#34495e');
                    root.style.setProperty('--light', '#2c3e50');
                    root.style.setProperty('--dark', '#ecf0f1');
                    document.body.style.background = '#1a252f';
                    document.body.style.color = '#ecf0f1';
                    break;
                default: // blue
                    root.style.setProperty('--primary', '#2c3e50');
                    root.style.setProperty('--secondary', '#3498db');
                    root.style.setProperty('--light', '#f8f9fa');
                    root.style.setProperty('--dark', '#2c3e50');
                    document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                    document.body.style.color = '#2c3e50';
            }
            
            currentTheme = theme;
        }
        
        // Change theme
        function changeTheme() {
            const theme = $(this).val();
            applyTheme(theme);
            
            // Save to settings
            settings.theme = theme;
            saveSettings();
            
            showToast(`Tema ${theme} diterapkan`, 'success');
        }
        
        // Backup data
        function backupData() {
            if (currentUser.role !== 'admin') return;
            
            showConfirmation(
                'Backup Data',
                'Data akan di-backup ke file terenkripsi (.posbackup). Lanjutkan?',
                () => {
                    try {
                        const backupData = {
                            menus,
                            categories,
                            orders,
                            users,
                            members,
                            settings,
                            system,
                            backupDate: new Date().toISOString(),
                            version: '2.0'
                        };
                        
                        const encryptedData = CryptoJS.AES.encrypt(
                            JSON.stringify(backupData),
                            ENCRYPTION_KEY
                        ).toString();
                        
                        const blob = new Blob([encryptedData], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `backup_pos_${moment().format('YYYYMMDD_HHmmss')}.posbackup`;
                        link.click();
                        
                        URL.revokeObjectURL(url);
                        
                        // Update last backup
                        system.lastBackup = new Date().toISOString();
                        saveSystem();
                        
                        showToast('Backup data berhasil', 'success');
                    } catch (error) {
                        showToast('Gagal membuat backup', 'error');
                        console.error('Backup error:', error);
                    }
                }
            );
        }
        
        // Handle restore file
        function handleRestoreFile(e) {
            if (currentUser.role !== 'admin') return;
            
            const file = e.target.files[0];
            if (!file) return;
            
            showConfirmation(
                'Restore Data',
                'Data saat ini akan diganti dengan data backup. Lanjutkan?',
                () => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const decryptedData = CryptoJS.AES.decrypt(
                                e.target.result,
                                ENCRYPTION_KEY
                            ).toString(CryptoJS.enc.Utf8);
                            
                            if (!decryptedData) {
                                throw new Error('File backup tidak valid');
                            }
                            
                            const backup = JSON.parse(decryptedData);
                            
                            // Validate backup structure
                            if (!backup.menus || !backup.categories || !backup.settings) {
                                throw new Error('Format backup tidak valid');
                            }
                            
                            // Restore data
                            menus = backup.menus || [];
                            categories = backup.categories || [];
                            orders = backup.orders || [];
                            users = backup.users || [];
                            members = backup.members || [];
                            settings = backup.settings || DEFAULT_DATA.settings;
                            system = backup.system || DEFAULT_DATA.system;
                            
                            // Save to localStorage
                            saveAllData();
                            
                            // Update UI
                            loadMenus();
                            loadCategories();
                            updateOrder();
                            updateStoreInfo();
                            updateTableNumbers();
                            updateStats();
                            
                            showToast('Data berhasil direstore', 'success');
                            
                            // Reload page to apply changes
                            setTimeout(() => location.reload(), 1000);
                            
                        } catch (error) {
                            showToast('Gagal memproses file backup', 'error');
                            console.error('Restore error:', error);
                        }
                    };
                    
                    reader.readAsText(file);
                },
                'danger'
            );
            
            // Reset file input
            $(this).val('');
        }
        
        // Reset data
        function resetData() {
            if (currentUser.role !== 'admin') return;
            
            promptForPassword('item', () => {
                showConfirmation(
                    'Reset Data',
                    'Semua data akan direset ke default. Data saat ini akan hilang permanen. Lanjutkan?',
                    () => {
                        try {
                            // Clear all data except current user
                            localStorage.clear();
                            
                            // Restore default data
                            initializeData();
                            
                            // Save current user
                            if (currentUser) {
                                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(currentUser));
                            }
                            
                            showToast('Data berhasil direset', 'success');
                            
                            // Reload page
                            setTimeout(() => location.reload(), 1000);
                            
                        } catch (error) {
                            showToast('Gagal reset data', 'error');
                            console.error('Reset error:', error);
                        }
                    },
                    'danger'
                );
            });
        }
        
        // Prompt for password
        function promptForPassword(type, callback) {
            const title = type === 'item' ? 
                'Password Edit/Hapus' : 
                'Password Kontrol Panel';
            
            const message = type === 'item' ?
                'Masukkan password keamanan untuk edit/hapus item.' :
                'Masukkan password keamanan untuk mengakses kontrol panel.';
            
            $('#passwordPromptTitle').html(`<i class="fas fa-lock"></i> ${title}`);
            $('#passwordPromptMessage').text(message);
            passwordPromptCallback = callback;
            $('#passwordPromptInput').val('');
            $('#passwordPromptModal').css('display', 'flex').find('input').focus();
        }
        
        // Submit password prompt
        function submitPasswordPrompt() {
            const password = $('#passwordPromptInput').val();
            const type = $('#passwordPromptTitle').text().includes('Kontrol Panel') ? 'panel' : 'item';
            const correctHash = type === 'panel' ? settings.panelSecurityCode : settings.itemSecurityCode;
            
            if (CryptoJS.SHA256(password).toString() === correctHash) {
                $('#passwordPromptModal').hide();
                if (passwordPromptCallback) {
                    passwordPromptCallback();
                }
                passwordPromptCallback = null;
            } else {
                showToast('Password keamanan salah', 'error');
                $('#passwordPromptInput').val('');
            }
        }
        
        // Show confirmation dialog
        function showConfirmation(title, message, callback, btnClass = 'success') {
            $('#confirmTitle').html(`<i class="fas fa-question-circle"></i> ${title}`);
            $('#confirmMessage').text(message);
            $('#confirmAction').data('callback', callback);
            $('#confirmAction').removeClass().addClass('btn btn-' + btnClass);
            $('#confirmationModal').css('display', 'flex');
        }
        
        // Confirm action
        function confirmAction() {
            const callback = $(this).data('callback');
            $('#confirmationModal').hide();
            
            if (callback && typeof callback === 'function') {
                callback();
            }
        }
        
        // Cancel action
        function cancelAction() {
            $('#confirmationModal').hide();
        }
        
        // Close modal
        function closeModal() {
            const modal = $(this).closest('.modal');
            modal.hide();
            
            // Clear kitchen interval
            if (modal.attr('id') === 'kitchenDisplayModal' && kitchenInterval) {
                clearInterval(kitchenInterval);
                kitchenInterval = null;
            }
        }
        
        // Open quick actions
        function openQuickActions() {
            $('#quickActionsModal').css('display', 'flex');
        }
        
        // Handle quick action
        function handleQuickAction() {
            const action = $(this).data('action');
            $('#quickActionsModal').hide();
            
            switch (action) {
                case 'newOrder':
                    clearOrder();
                    showToast('Pesanan baru dibuat', 'success');
                    break;
                case 'viewReports':
                    openReportsModal();
                    break;
                case 'kitchenView':
                    openKitchenModal();
                    break;
                case 'clearAll':
                    clearOrder();
                    break;
                case 'backupNow':
                    backupData();
                    break;
                case 'toggleTheme':
                    const themes = ['default', 'green', 'red', 'purple', 'dark'];
                    const currentIndex = themes.indexOf(currentTheme);
                    const nextTheme = themes[(currentIndex + 1) % themes.length];
                    applyTheme(nextTheme);
                    showToast(`Tema ${nextTheme} diterapkan`, 'success');
                    break;
            }
        }
        
        // Update stats
        function updateStats() {
            $('#totalMenus').text(menus.length);
            $('#totalOrders').text(system.totalTransactions || 0);
            $('#totalMembers').text(members.length);
            $('#totalRevenue').text(formatCurrency(system.totalRevenue || 0));
        }
        
        // Update current date
        function updateCurrentDate() {
            const now = moment();
            $('#currentDate').html(`
                <i class="far fa-calendar"></i>
                <span>${now.format('dddd, DD MMMM YYYY')}</span>
            `);
        }
        
        // Auto-save order
        function autoSaveOrder() {
            if (currentOrder.items.length > 0) {
                localStorage.setItem(STORAGE_KEYS.CURRENT_ORDER, JSON.stringify(currentOrder));
            }
        }
        
        // Play sound
        function playSound(type) {
            if (!settings.soundNotifications) return;
            
            try {
                const audio = document.getElementById(type === 'cash' ? 'cashSound' : 'notificationSound');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Audio play failed:', e));
                }
            } catch (error) {
                console.log('Sound error:', error);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const $toast = $('#toast');
            
            $toast.removeClass('success error warning info')
                  .addClass(type + ' show');
            
            $('#toast-message').text(message);
            
            switch (type) {
                case 'success':
                    $toast.find('i').attr('class', 'fas fa-check-circle');
                    break;
                case 'error':
                    $toast.find('i').attr('class', 'fas fa-exclamation-circle');
                    break;
                case 'warning':
                    $toast.find('i').attr('class', 'fas fa-exclamation-triangle');
                    break;
                default:
                    $toast.find('i').attr('class', 'fas fa-info-circle');
            }
            
            // Auto-hide
            setTimeout(() => {
                $toast.removeClass('show');
            }, 3000);
        }
        
        // Show loading overlay
        function showLoading(message = 'Memproses...') {
            $('#loadingOverlay').css('display', 'flex');
        }
        
        // Hide loading overlay
        function hideLoading() {
            $('#loadingOverlay').hide();
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // Save all data
        function saveAllData() {
            localStorage.setItem(STORAGE_KEYS.MENUS, JSON.stringify(menus));
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
            localStorage.setItem(STORAGE_KEYS.MEMBERS, JSON.stringify(members));
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            localStorage.setItem(STORAGE_KEYS.SYSTEM, JSON.stringify(system));
        }
        
        // Individual save functions
        function saveMenus() {
            localStorage.setItem(STORAGE_KEYS.MENUS, JSON.stringify(menus));
        }
        
        function saveCategories() {
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
        }
        
        function saveOrders() {
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
        }
        
        function saveUsers() {
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
        }
        
        function saveMembers() {
            localStorage.setItem(STORAGE_KEYS.MEMBERS, JSON.stringify(members));
        }
        
        function saveSettings() {
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
        }
        
        function saveSystem() {
            localStorage.setItem(STORAGE_KEYS.SYSTEM, JSON.stringify(system));
        }
        
        // Initialize on load
        $(document).ready(function() {
            // Any additional initialization
        });
    </script>
</body>
</html>
